#!/bin/bash

# Test latency of a single VPN server

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=./lazyvpn-common
source "$SCRIPT_DIR/lazyvpn-common" || exit 1

SERVER_NAME="$1"

if [[ -z "$SERVER_NAME" ]]; then
  error "Server name required"
  exit 1
fi

WG_DIR="$HOME/.config/lazyvpn/wireguard"
CONF_FILE="$WG_DIR/${SERVER_NAME}.conf"

if [[ ! -f "$CONF_FILE" ]]; then
  error "Server config not found: $CONF_FILE"
  exit 1
fi

# Get pretty server name for display
PRETTY_SERVER=$(get_pretty_server_name "$SERVER_NAME" "$SCRIPT_DIR")

info "Testing latency for $PRETTY_SERVER..."

# Extract endpoint IP
endpoint=$(grep -m1 "^Endpoint" "$CONF_FILE" | cut -d= -f2 | tr -d ' ')
server_ip=$(echo "$endpoint" | cut -d: -f1)

if [[ -z "$server_ip" ]]; then
  error "Could not extract endpoint IP from config"
  exit 1
fi

# Ping the server (5 packets, 2 second timeout)
ping_output=$(LC_ALL=C ping -c 5 -W 2 "$server_ip" 2>/dev/null)

if [[ -z "$ping_output" ]]; then
  error "Server did not respond to ping (timeout)"
  exit 1
fi

avg_latency=$(echo "$ping_output" | awk '/^rtt/ {split($4,a,"/"); print int(a[2])}')
packet_loss=$(echo "$ping_output" | grep "packet loss" | awk '{print $6}')

if [[ -n "$avg_latency" ]] && [[ "$avg_latency" =~ ^[0-9]+$ ]]; then
  info "✓ Average Latency: ${avg_latency}ms"
  info "✓ Packet Loss: ${packet_loss}"
  # Record performance data
  record_performance "$SERVER_NAME" "latency" "$avg_latency" "ok"
else
  error "✗ Could not determine latency."
  record_performance "$SERVER_NAME" "latency" "0" "failed"
fi
