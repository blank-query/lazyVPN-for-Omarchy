#!/bin/bash

# Setup firewall-based killswitch (requires sudo)
# This script creates iptables chains for LazyVPN killswitch

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=./lazyvpn-common
source "$SCRIPT_DIR/lazyvpn-common" || exit 1

# Check if running as root
if [[ $EUID -ne 0 ]]; then
  info "Firewall killswitch requires root privileges"
  info "You will be prompted for your password..."
  exec sudo "$0" "$@"
fi

info "Setting up firewall killswitch..."

# Create custom chains for LazyVPN if they don't exist
if ! iptables -L LAZYVPN_OUT -n &>/dev/null; then
  iptables -N LAZYVPN_OUT
  info "Created LAZYVPN_OUT chain"
fi

if ! ip6tables -L LAZYVPN_OUT -n &>/dev/null; then
  ip6tables -N LAZYVPN_OUT
  info "Created LAZYVPN_OUT chain (IPv6)"
fi

# Flush existing rules in our chains
iptables -F LAZYVPN_OUT
ip6tables -F LAZYVPN_OUT
info "Flushed existing rules from LAZYVPN chains"

# Insert jump to our chain at the beginning of OUTPUT if not already present
if ! iptables -C OUTPUT -j LAZYVPN_OUT &>/dev/null; then
  iptables -I OUTPUT 1 -j LAZYVPN_OUT
  info "Added jump to LAZYVPN_OUT in OUTPUT chain"
fi

if ! ip6tables -C OUTPUT -j LAZYVPN_OUT &>/dev/null; then
  ip6tables -I OUTPUT 1 -j LAZYVPN_OUT
  info "Added jump to LAZYVPN_OUT in OUTPUT chain (IPv6)"
fi

# By default, killswitch is inactive (RETURN lets traffic through)
iptables -A LAZYVPN_OUT -j RETURN
ip6tables -A LAZYVPN_OUT -j RETURN

info "âœ“ Firewall killswitch chains created successfully"
info ""
info "To enable killswitch, use: lazyvpn-toggle-killswitch"
info "To allow local network access, use: lazyvpn-toggle-local-network"
