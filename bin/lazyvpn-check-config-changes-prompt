#!/bin/bash

# Check for config changes and show notification if any detected
# Called by menu functions to notify user of added/removed servers

# Source common functions for notify()
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lazyvpn-common" || exit 1
# shellcheck source=./lazyvpn-common

CONFIG_DIR="$HOME/.config/lazyvpn"
CACHE_FILE="$CONFIG_DIR/.server-list-cache"
WG_DIR="$CONFIG_DIR/wireguard"

export PATH="$HOME/.local/share/omarchy/bin:$PATH"

# Get current configs (basenames without .conf extension)
mapfile -t current_configs < <(find "$WG_DIR" -maxdepth 1 -name "*.conf" -type f -exec basename {} .conf \; 2>/dev/null | sort)

# Initialize arrays
NEW_CONFIGS=()
REMOVED_CONFIGS=()

# Read cached configs if file exists
if [[ -f "$CACHE_FILE" ]]; then
  mapfile -t cached_configs < "$CACHE_FILE"

  # Filter out empty strings from cached configs
  filtered_cached=()
  for cached in "${cached_configs[@]}"; do
    [[ -n "$cached" ]] && filtered_cached+=("$cached")
  done
  cached_configs=("${filtered_cached[@]}")

  # Find new configs (in current but not in cache)
  for config in "${current_configs[@]}"; do
    found=false
    for cached in "${cached_configs[@]}"; do
      if [[ "$config" == "$cached" ]]; then
        found=true
        break
      fi
    done
    if [[ "$found" == "false" ]]; then
      NEW_CONFIGS+=("$config")
    fi
  done

  # Find removed configs (in cache but not in current)
  for cached in "${cached_configs[@]}"; do
    found=false
    for config in "${current_configs[@]}"; do
      if [[ "$cached" == "$config" ]]; then
        found=true
        break
      fi
    done
    if [[ "$found" == "false" ]]; then
      REMOVED_CONFIGS+=("$cached")
    fi
  done
fi

# Update cache with current configs
printf "%s\n" "${current_configs[@]}" > "$CACHE_FILE"

# Show notification if changes detected
if [[ ${#NEW_CONFIGS[@]} -gt 0 ]] || [[ ${#REMOVED_CONFIGS[@]} -gt 0 ]]; then
  change_message="LazyVPN Server Changes"

  if [[ ${#NEW_CONFIGS[@]} -gt 0 ]] && [[ ${#REMOVED_CONFIGS[@]} -gt 0 ]]; then
    # Both added and removed
    change_message+="\n‚úÖ Added: ${#NEW_CONFIGS[@]} server(s)\nüóëÔ∏è  Removed: ${#REMOVED_CONFIGS[@]} server(s)"
  elif [[ ${#NEW_CONFIGS[@]} -gt 0 ]]; then
    # Only added
    change_message+="\n‚úÖ Added ${#NEW_CONFIGS[@]} server(s)"
  else
    # Only removed
    change_message+="\nüóëÔ∏è  Removed ${#REMOVED_CONFIGS[@]} server(s)"
  fi

  notify "$change_message"
fi

exit 0
