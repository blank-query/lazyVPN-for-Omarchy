#!/bin/bash

# LazyVPN Uninstallation Script

echo "======================================="
echo "  LazyVPN Uninstaller"
echo "======================================="
echo ""

# --- Define Paths ---
LAZYVPN_BIN="$HOME/.local/share/lazyvpn/bin"

# Source common functions (must happen before bin dir is removed in Step 2)
if [[ -f "$LAZYVPN_BIN/lazyvpn-common" ]]; then
  source "$LAZYVPN_BIN/lazyvpn-common"
fi
OMARCHY_BIN="$HOME/.local/share/omarchy/bin"
CONFIG_DIR="$HOME/.config/lazyvpn"
AUTOSTART_FILE="$HOME/.config/autostart/lazyvpn.desktop"
OMARCHY_MENU_FILE="$OMARCHY_BIN/omarchy-menu"
OMARCHY_MENU_BACKUP="$OMARCHY_MENU_FILE.backup"

# --- Check for active VPN connection ---
echo "Checking for active VPN connection..."
CONNECTION_NAME="wg0"  # Default

if [[ -f "$CONFIG_DIR/config" ]]; then
  # Load connection name from config if it exists
  source "$CONFIG_DIR/config" 2>/dev/null
  CONNECTION_NAME="${CONNECTION_NAME:-wg0}"
fi

# Check if VPN is actually connected (not just if interface exists)
VPN_CONNECTED=false
if ip link show "$CONNECTION_NAME" &>/dev/null; then
  state=$(networkctl status "$CONNECTION_NAME" 2>/dev/null | grep -E "^\s*State:" | awk '{print $2}')
  if [[ "$state" == "routable" ]] || [[ "$state" == "degraded" ]]; then
    VPN_CONNECTED=true
  fi
fi

if [[ "$VPN_CONNECTED" == "true" ]]; then
  echo ""
  echo "⚠️  WARNING: VPN connection is currently ACTIVE!"
  echo ""
  echo "You are currently connected to a VPN server."
  echo "If you uninstall while connected, you may experience:"
  echo "  • Loss of internet connectivity"
  echo "  • Difficulty disconnecting from the VPN"
  echo "  • Network routing issues"
  echo ""
  read -r -p "Disconnect from VPN before uninstalling? [Y/n] " disconnect_choice

  if [[ ! "$disconnect_choice" =~ ^[Nn]$ ]]; then
    echo ""
    echo "Disconnecting from VPN..."

    # Try to use the disconnect script if it exists
    if [[ -x "$LAZYVPN_BIN/lazyvpn-disconnect" ]]; then
      "$LAZYVPN_BIN/lazyvpn-disconnect" 2>/dev/null
    else
      # Manual disconnect if script not available
      echo "  - Removing systemd-networkd configuration files..."
      secure_delete --sudo "/etc/systemd/network/99-${CONNECTION_NAME}.netdev" "/etc/systemd/network/99-${CONNECTION_NAME}.network"

      echo "  - Removing VPN interface..."
      sudo ip link delete "$CONNECTION_NAME" 2>/dev/null || true

      echo "  - Restarting systemd-networkd..."
      sudo systemctl restart systemd-networkd
    fi

    echo "  ✓ Disconnected successfully"
    sleep 2
  else
    echo ""
    echo "⚠️  Proceeding with uninstall while VPN is connected."
    echo "   You may need to manually disconnect after uninstall:"
    echo "   sudo ip link delete $CONNECTION_NAME"
    echo "   sudo shred -u /etc/systemd/network/99-${CONNECTION_NAME}.*"
    echo "   sudo systemctl restart systemd-networkd"
    echo ""
    read -r -p "Press Enter to continue with uninstall..."
  fi
else
  echo "  - No active VPN connection detected."
fi
echo ""

# --- User Choice for WireGuard Configs ---
WG_CONFIG_DIR="$CONFIG_DIR/wireguard"
echo "Your WireGuard server configurations are stored in:"
echo "$WG_CONFIG_DIR"
echo ""

delete_configs="n" # Default to not deleting configs

if [[ -d "$WG_CONFIG_DIR" ]] && ls "$WG_CONFIG_DIR"/*.conf 1>/dev/null 2>&1; then
  echo "The following WireGuard config files were found:"
  ls -1 "$WG_CONFIG_DIR"/*.conf | sed "s|^$WG_CONFIG_DIR/|  - |"
  echo ""
  read -r -p "Do you want to DELETE these .conf files? (This cannot be undone) [y/N] " delete_configs
  if [[ "$delete_configs" =~ ^[Yy]$ ]]; then
    echo "-> WireGuard configs will be permanently deleted."
  else
    echo "-> WireGuard configs will be kept."
  fi
else
  echo "No WireGuard config files found."
  echo "-> No WireGuard configs to delete."
fi
echo ""

# --- Step 1: Clean up iptables rules ---
echo "Step 1: Cleaning up firewall rules..."

# Check if killswitch was ever used by looking for the KILLSWITCH key in config
KILLSWITCH_CONFIGURED=false
if [[ -f "$CONFIG_DIR/config" ]] && grep -q "^KILLSWITCH=" "$CONFIG_DIR/config"; then
  KILLSWITCH_CONFIGURED=true
fi

if [[ "$KILLSWITCH_CONFIGURED" == "true" ]]; then
  # Killswitch was configured at some point, check if rules exist (requires sudo)
  if sudo iptables -L LAZYVPN_OUT >/dev/null 2>&1; then
    echo "  - Found existing firewall rules. Removing them..."
    sudo iptables -D OUTPUT -j LAZYVPN_OUT 2>/dev/null && echo "    - Removed IPv4 OUTPUT jump"
    sudo ip6tables -D OUTPUT -j LAZYVPN_OUT 2>/dev/null && echo "    - Removed IPv6 OUTPUT jump"
    sudo iptables -F LAZYVPN_OUT 2>/dev/null && echo "    - Flushed LAZYVPN_OUT chain"
    sudo ip6tables -F LAZYVPN_OUT 2>/dev/null && echo "    - Flushed LAZYVPN_OUT chain (IPv6)"
    sudo iptables -X LAZYVPN_OUT 2>/dev/null && echo "    - Deleted LAZYVPN_OUT chain"
    sudo ip6tables -X LAZYVPN_OUT 2>/dev/null && echo "    - Deleted LAZYVPN_OUT chain (IPv6)"
    echo "  Firewall cleanup complete."
  else
    echo "  - No LazyVPN firewall rules found (already removed)."
  fi
else
  echo "  - Killswitch was never configured, skipping firewall cleanup."
fi

# Clean up IPv6 blocking rules if they exist
if sudo ip6tables -L LAZYVPN_IPV6_BLOCK >/dev/null 2>&1; then
  echo "  - Found IPv6 blocking rules. Removing them..."
  sudo ip6tables -D OUTPUT -j LAZYVPN_IPV6_BLOCK 2>/dev/null && echo "    - Removed IPv6 OUTPUT jump"
  sudo ip6tables -F LAZYVPN_IPV6_BLOCK 2>/dev/null && echo "    - Flushed LAZYVPN_IPV6_BLOCK chain"
  sudo ip6tables -X LAZYVPN_IPV6_BLOCK 2>/dev/null && echo "    - Deleted LAZYVPN_IPV6_BLOCK chain"
fi

# Re-enable IPv6 if it was disabled by LazyVPN
if [[ -f /etc/sysctl.d/99-lazyvpn-ipv6.conf ]]; then
  echo "  - Re-enabling IPv6..."
  sudo sysctl -w net.ipv6.conf.all.disable_ipv6=0 >/dev/null 2>&1
  sudo sysctl -w net.ipv6.conf.default.disable_ipv6=0 >/dev/null 2>&1
  sudo sysctl -w net.ipv6.conf.lo.disable_ipv6=0 >/dev/null 2>&1
  secure_delete --sudo /etc/sysctl.d/99-lazyvpn-ipv6.conf
  echo "    - IPv6 re-enabled"
fi

# Save cleaned iptables rules
if command -v iptables-save &>/dev/null; then
  sudo iptables-save > /etc/iptables/iptables.rules 2>/dev/null
  sudo ip6tables-save > /etc/iptables/ip6tables.rules 2>/dev/null
  echo "  - Saved cleaned firewall rules"
fi

echo ""

# --- Step 2: Remove LazyVPN scripts and directory ---
echo "Step 2: Securely removing LazyVPN scripts..."
if [[ -d "$LAZYVPN_BIN" ]]; then
  bin_files=()
  for f in "$LAZYVPN_BIN"/*; do [[ -f "$f" ]] && bin_files+=("$f"); done
  if [[ ${#bin_files[@]} -gt 0 ]]; then
    secure_delete "${bin_files[@]}"
  fi
  # Remove directory structure
  rmdir "$LAZYVPN_BIN" 2>/dev/null

  # Also remove parent directory if empty
  LAZYVPN_SHARE="$(dirname "$LAZYVPN_BIN")"
  if [[ -d "$LAZYVPN_SHARE" ]] && [[ -z "$(ls -A "$LAZYVPN_SHARE" 2>/dev/null)" ]]; then
    rmdir "$LAZYVPN_SHARE" 2>/dev/null
    echo "  - Removed empty parent directory"
  fi
else
  echo "  - No LazyVPN directory found."
fi
echo ""

# --- Step 3: Remove LazyVPN from omarchy-menu ---
echo "Step 3: Removing LazyVPN integration from omarchy-menu..."

# Check if LazyVPN is integrated
if grep -q "LazyVPN" "$OMARCHY_MENU_FILE"; then
  # Try surgical removal with AWK
  if awk '
    # Skip the show_lazyvpn_menu function and its blank line after
    /^show_lazyvpn_menu\(\) \{/ {
      getline  # skip the lazyvpn-menu line
      getline  # skip the }
      getline  # skip the blank line after
      next
    }

    # Remove LazyVPN from the menu options string
    /menu "Go" ".*LazyVPN/ {
      gsub(/󰖂  LazyVPN\\n/, "")
    }

    # Skip the lazyvpn case handler line
    /^\s*\*lazyvpn\*\) show_lazyvpn_menu ;;/ {
      next
    }

    # Print all other lines
    { print }
  ' "$OMARCHY_MENU_FILE" > "$OMARCHY_MENU_FILE.tmp"; then
    # AWK succeeded, apply changes
    mv "$OMARCHY_MENU_FILE.tmp" "$OMARCHY_MENU_FILE" && chmod +x "$OMARCHY_MENU_FILE"
    echo "  - Removed LazyVPN integration from omarchy-menu"
  else
    # AWK failed, restore from backup if available
    echo "  - Surgical removal failed, attempting restore from backup..."
    if [[ -f "$OMARCHY_MENU_BACKUP" ]]; then
      cp "$OMARCHY_MENU_BACKUP" "$OMARCHY_MENU_FILE"
      chmod +x "$OMARCHY_MENU_FILE"
      echo "  - Restored omarchy-menu from backup"
    else
      echo "  ⚠ WARNING: Backup not found. omarchy-menu may need manual repair."
      echo "  You can restore Omarchy by reinstalling it."
    fi
    secure_delete "$OMARCHY_MENU_FILE.tmp"
  fi

  echo "  - Restarting menu to apply changes..."
  nohup omarchy-restart-walker > /dev/null 2>&1 &
else
  echo "  - LazyVPN not found in omarchy-menu (already removed or never installed)"
fi
echo ""

# --- Step 4: Remove keyboard shortcut ---
echo "Step 4: Removing keyboard shortcut..."

# Remove from Hyprland bindings
HYPR_BINDINGS="$HOME/.config/hypr/bindings.conf"
if [[ -f "$HYPR_BINDINGS" ]]; then
  if grep -q "LazyVPN" "$HYPR_BINDINGS"; then
    # Remove the LazyVPN comment and keybinding lines
    sed -i '/# LazyVPN/d' "$HYPR_BINDINGS"
    sed -i '/bindd = SUPER, L, LazyVPN/d' "$HYPR_BINDINGS"
    echo "  - Removed SUPER+L keybinding from Hyprland"

    # Reload Hyprland config
    hyprctl reload >/dev/null 2>&1
    echo "  - Reloaded Hyprland configuration"
  else
    echo "  - No LazyVPN keybinding found in Hyprland config"
  fi
else
  echo "  - Hyprland bindings.conf not found"
fi

# Remove from keybindings helper
KEYBINDINGS_SCRIPT="$OMARCHY_BIN/omarchy-menu-keybindings"
if [[ -f "$KEYBINDINGS_SCRIPT" ]]; then
  if grep -q "LazyVPN" "$KEYBINDINGS_SCRIPT"; then
    sed -i '/echo "SUPER,L,LazyVPN,exec,lazyvpn-menu"/d' "$KEYBINDINGS_SCRIPT"
    echo "  - Removed from keybindings helper"
  else
    echo "  - No LazyVPN entry found in keybindings helper"
  fi
else
  echo "  - Keybindings script not found"
fi
echo ""

# --- Step 5: Remove Waybar integration ---
echo "Step 5: Removing Waybar integration..."

WAYBAR_CONFIG="$HOME/.config/waybar/config.jsonc"
WAYBAR_STYLE="$HOME/.config/waybar/style.css"

if [[ -f "$WAYBAR_CONFIG" ]]; then
  if grep -q "custom/lazyvpn" "$WAYBAR_CONFIG"; then
    # Use a single awk script to safely remove lazyvpn from waybar config
    # This removes it from modules-right array AND removes the module definition
    awk '
      # Track if we are inside modules-right array
      /"modules-right"/ { in_modules_right = 1 }

      # Remove custom/lazyvpn from modules-right array only
      in_modules_right && /"custom\/lazyvpn"/ {
        gsub(/, "custom\/lazyvpn"/, "")
        gsub(/"custom\/lazyvpn", /, "")
        gsub(/"custom\/lazyvpn"/, "")
      }

      # Closing bracket ends the modules-right array
      in_modules_right && /\]/ { in_modules_right = 0 }

      # Skip the custom/lazyvpn module definition block entirely
      /^[[:space:]]*,?"custom\/lazyvpn": \{/ {
        brace_count = 1
        while (brace_count > 0 && (getline) > 0) {
          if (/\{/) brace_count++
          if (/\}/) brace_count--
        }
        next
      }

      { print }
    ' "$WAYBAR_CONFIG" > "$WAYBAR_CONFIG.tmp" && mv "$WAYBAR_CONFIG.tmp" "$WAYBAR_CONFIG"

    echo "  - Removed custom/lazyvpn from Waybar config"

    # Reload waybar if running
    if pgrep -x waybar > /dev/null; then
      pkill -SIGUSR2 waybar 2>/dev/null || true
      echo "  - Sent reload signal to Waybar"
    fi
  else
    echo "  - No LazyVPN integration found in Waybar config"
  fi
else
  echo "  - Waybar config not found"
fi

# Remove CSS styling
if [[ -f "$WAYBAR_STYLE" ]]; then
  if grep -q "#custom-lazyvpn" "$WAYBAR_STYLE"; then
    # Remove the LazyVPN CSS block (comment + rule)
    sed -i '/\/\* LazyVPN status indicator \*\//,/^}$/d' "$WAYBAR_STYLE"
    # Also try alternate pattern without closing brace on own line
    sed -i '/#custom-lazyvpn {/,/}/d' "$WAYBAR_STYLE"
    echo "  - Removed LazyVPN styling from Waybar CSS"
  else
    echo "  - No LazyVPN styling found in Waybar CSS"
  fi
else
  echo "  - Waybar style.css not found"
fi
echo ""

# --- Step 6: Remove LazyVPN from PATH ---
echo "Step 6: Removing LazyVPN from PATH..."
SHELL_RC=""
if [[ -n "$BASH_VERSION" ]]; then
  SHELL_RC="$HOME/.bashrc"
elif [[ -n "$ZSH_VERSION" ]]; then
  SHELL_RC="$HOME/.zshrc"
fi

if [[ -n "$SHELL_RC" ]] && [[ -f "$SHELL_RC" ]]; then
  if grep -q "/.local/share/lazyvpn/bin" "$SHELL_RC"; then
    # Remove the LazyVPN PATH entry and its comment
    sed -i '/# LazyVPN/d' "$SHELL_RC"
    sed -i '\|export PATH="\$HOME/.local/share/lazyvpn/bin:\$PATH"|d' "$SHELL_RC"
    echo "  - Removed LazyVPN from PATH in $SHELL_RC"
  else
    echo "  - LazyVPN not found in PATH"
  fi
else
  echo "  - Could not detect shell config file"
fi
echo ""

# --- Step 7: Remove Autostart entry ---
echo "Step 7: Removing Autostart entry..."
if [[ -f "$AUTOSTART_FILE" ]]; then
  secure_delete "$AUTOSTART_FILE"
  echo "  - Removed autostart file."
else
  echo "  - No autostart file found."
fi
echo ""

# --- Step 8: Stop auto-recover daemon if running ---
echo "Step 8: Stopping auto-recover daemon..."
AUTO_RECOVER_PID_FILE="$CONFIG_DIR/.auto-recover.pid"
if [[ -f "$AUTO_RECOVER_PID_FILE" ]]; then
  AUTO_RECOVER_PID=$(cat "$AUTO_RECOVER_PID_FILE" 2>/dev/null)
  if [[ -n "$AUTO_RECOVER_PID" ]] && kill -0 "$AUTO_RECOVER_PID" 2>/dev/null; then
    kill "$AUTO_RECOVER_PID" 2>/dev/null
    echo "  - Stopped auto-recover daemon (PID: $AUTO_RECOVER_PID)"
    sleep 1
  else
    echo "  - Auto-recover daemon not running"
  fi
else
  echo "  - No auto-recover daemon found"
fi
echo ""

# --- Step 9: Securely Remove LazyVPN Config Files ---
echo "Step 9: Securely removing LazyVPN configuration files..."
if [[ ! -d "$CONFIG_DIR" ]]; then
  echo "  - Configuration directory not found."
else
  # Securely delete LazyVPN's own config files (not server configs)
  echo "  - Securely deleting LazyVPN config and cache files..."
  secure_delete "$CONFIG_DIR/config" "$CONFIG_DIR/.server-list-cache" \
    "$CONFIG_DIR/favorites" "$CONFIG_DIR/.auto-recover.pid" \
    "$CONFIG_DIR/auto-recover.log" "$CONFIG_DIR/debug.log" "$CONFIG_DIR/state"

  # Securely delete provider credentials (contains private keys!)
  PROVIDERS_DIR="$CONFIG_DIR/providers"
  if [[ -d "$PROVIDERS_DIR" ]]; then
    provider_files=()
    for f in "$PROVIDERS_DIR"/*.conf; do [[ -f "$f" ]] && provider_files+=("$f"); done
    if [[ ${#provider_files[@]} -gt 0 ]]; then
      echo "  - Securely deleting provider credentials (contains private keys)..."
      secure_delete "${provider_files[@]}"
    fi
    rmdir "$PROVIDERS_DIR" 2>/dev/null
  fi

  # Securely delete server cache (shows VPN provider usage)
  CACHE_DIR="$CONFIG_DIR/cache"
  if [[ -d "$CACHE_DIR" ]]; then
    echo "  - Securely deleting server cache..."
    cache_files=()
    for f in "$CACHE_DIR"/*; do [[ -f "$f" ]] && cache_files+=("$f"); done
    [[ ${#cache_files[@]} -gt 0 ]] && secure_delete "${cache_files[@]}"
    rmdir "$CACHE_DIR" 2>/dev/null
  fi

  # Handle WireGuard server configs based on user choice
  if [[ "$delete_configs" =~ ^[Yy]$ ]]; then
    # User wants to delete server configs - shred them
    if [[ -d "$WG_CONFIG_DIR" ]]; then
      wg_files=()
      for f in "$WG_CONFIG_DIR"/*.conf; do [[ -f "$f" ]] && wg_files+=("$f"); done
      if [[ ${#wg_files[@]} -gt 0 ]]; then
        echo "  - Securely deleting WireGuard server configs..."
        secure_delete "${wg_files[@]}"
      fi
    fi
    # Remove the config directory structure (files already shredded)
    rmdir "$WG_CONFIG_DIR" 2>/dev/null
    rmdir "$CONFIG_DIR" 2>/dev/null
    if [[ -d "$CONFIG_DIR" ]]; then
      echo "  - Some files could not be removed. Directory preserved: $CONFIG_DIR"
    else
      echo "  - Removed configuration directory: $CONFIG_DIR"
    fi
  else
    # User wants to keep server configs - preserve wireguard folder
    echo "  - Preserved WireGuard server configs in: $WG_CONFIG_DIR"
  fi
fi
echo ""

# --- Step 10: Clean up systemd-networkd files ---
echo "Step 10: Cleaning up systemd-networkd configuration..."
NETDEV_FILE="/etc/systemd/network/99-${CONNECTION_NAME}.netdev"
NETWORK_FILE="/etc/systemd/network/99-${CONNECTION_NAME}.network"

if [[ -f "$NETDEV_FILE" ]] || [[ -f "$NETWORK_FILE" ]]; then
  echo "  - Found leftover systemd-networkd files. Securely deleting..."
  secure_delete --sudo "$NETDEV_FILE" "$NETWORK_FILE"

  # Check if interface still exists
  if ip link show "$CONNECTION_NAME" &>/dev/null; then
    echo "  - VPN interface still exists. Removing..."
    sudo ip link delete "$CONNECTION_NAME" 2>/dev/null && echo "    - Removed interface: $CONNECTION_NAME"
  fi

  echo "  - Restarting systemd-networkd to apply changes..."
  sudo systemctl restart systemd-networkd
  echo "  - Systemd-networkd cleanup complete."
else
  echo "  - No systemd-networkd files found to clean up."
fi
echo ""

# --- Step 11: Remove sudoers configuration ---
echo "Step 11: Removing sudoers configuration..."
if sudo test -f /etc/sudoers.d/lazyvpn; then
  secure_delete --sudo /etc/sudoers.d/lazyvpn
else
  echo "  - No sudoers configuration found"
fi
echo ""

# --- Step 12: Clean up system logs (surgical approach) ---
echo "Step 12: System log cleanup (optional)..."
echo ""
echo "═══════════════════════════════════════════════════════════"
echo "  Privacy Note: System Logs"
echo "═══════════════════════════════════════════════════════════"
echo ""
echo "LazyVPN connection history may exist in systemd journal logs."
echo "These logs contain:"
echo "  • Timestamps of VPN connections/disconnections"
echo "  • Interface names (e.g., ${CONNECTION_NAME:-wg0})"
echo "  • Configuration file paths"
echo ""
echo "LazyVPN can surgically identify and securely delete ONLY the"
echo "journal files containing VPN logs, preserving other system logs."
echo ""
echo "⚠️  WARNING: This will:"
echo "   • Stop systemd-journald temporarily"
echo "   • Shred journal files containing VPN connection history"
echo "   • Preserve journal files from periods without VPN activity"
echo "   • Restart systemd-journald"
echo ""
read -r -p "Securely remove journal files containing VPN logs? [y/N]: " clear_logs

if [[ "$clear_logs" =~ ^[Yy]$ ]]; then
  echo ""
  echo "  - Scanning journal files for VPN activity..."

  # Get machine ID for journal directory
  MACHINE_ID=$(cat /etc/machine-id 2>/dev/null)
  if [[ -z "$MACHINE_ID" ]]; then
    echo "    ✗ Failed to read machine-id"
  else
    JOURNAL_DIR="/var/log/journal/$MACHINE_ID"
    if [[ ! -d "$JOURNAL_DIR" ]]; then
      JOURNAL_DIR="/run/log/journal/$MACHINE_ID"
    fi

    if [[ ! -d "$JOURNAL_DIR" ]]; then
      echo "    ✗ Journal directory not found"
    else
      # Find all system journal files and check for VPN logs
      VPN_JOURNALS=()
      INTERFACE_NAME="${CONNECTION_NAME:-wg0}"

      for journal_file in "$JOURNAL_DIR"/system*.journal; do
        if [[ -f "$journal_file" ]]; then
          # Check if this journal contains VPN logs
          if journalctl --file="$journal_file" -u systemd-networkd --no-pager 2>/dev/null | grep -q "$INTERFACE_NAME"; then
            VPN_JOURNALS+=("$journal_file")
          fi
        fi
      done

      TOTAL_JOURNALS=$(find "$JOURNAL_DIR" -name "system*.journal" -type f | wc -l)
      VPN_COUNT=${#VPN_JOURNALS[@]}

      echo "    Found VPN logs in $VPN_COUNT of $TOTAL_JOURNALS system journal files"

      if [[ $VPN_COUNT -eq 0 ]]; then
        echo "    ✓ No VPN logs found in journal files"
      else
        # Setup cleanup trap to ensure journald always restarts
        JOURNALD_STOPPED=false
        cleanup_journald() {
          if [[ "$JOURNALD_STOPPED" == "true" ]]; then
            echo ""
            echo "  ! Interrupted - restarting systemd-journald..."
            sudo systemctl start systemd-journald 2>/dev/null
            sleep 1
            if systemctl is-active --quiet systemd-journald; then
              echo "    ✓ systemd-journald restarted successfully"
            else
              echo "    ✗ WARNING: systemd-journald may still be stopped!"
              echo "    Please manually start it: sudo systemctl start systemd-journald"
            fi
          fi
        }
        trap cleanup_journald EXIT INT TERM

        echo ""
        echo "  - Stopping systemd-journald..."
        if sudo systemctl stop systemd-journald 2>/dev/null; then
          JOURNALD_STOPPED=true
          echo "    ✓ Stopped systemd-journald"

          echo ""
          echo "  - Securely deleting journal files with VPN logs..."
          secure_delete --sudo "${VPN_JOURNALS[@]}"

          echo ""
          echo "  - Restarting systemd-journald..."
          sudo systemctl start systemd-journald 2>/dev/null
          sleep 1

          if systemctl is-active --quiet systemd-journald; then
            JOURNALD_STOPPED=false
            trap - EXIT INT TERM  # Remove trap after successful restart
            echo "    ✓ systemd-journald restarted successfully"
            clean_count=$((TOTAL_JOURNALS - VPN_COUNT))
            echo "      • Preserved: $clean_count journal file(s) without VPN logs"
          else
            echo "    ✗ Failed to restart systemd-journald"
            echo "    Please manually start it: sudo systemctl start systemd-journald"
          fi
        else
          echo "    ✗ Failed to stop systemd-journald"
        fi
      fi
    fi
  fi
else
  echo ""
  echo "  - System logs preserved."
  echo ""
  echo "To manually clear VPN logs later, you would need to:"
  echo "  1. Identify journal files containing VPN logs"
  echo "  2. Stop systemd-journald"
  echo "  3. Securely delete those files"
  echo "  4. Restart systemd-journald"
fi
echo ""

# --- Step 13: Clean up shell history ---
echo "Step 13: Cleaning shell history..."
echo ""
echo "Removing VPN-related commands from shell history files..."

INTERFACE_NAME="${CONNECTION_NAME:-wg0}"
# Escape special regex characters in interface name (dots become literal dots)
INTERFACE_NAME_ESCAPED="${INTERFACE_NAME//./\\.}"
cleaned_count=0
skipped_count=0

# List of common shell history files
HISTORY_FILES=(
  "$HOME/.bash_history"
  "$HOME/.zsh_history"
  "$HOME/.local/share/fish/fish_history"
)

for hist_file in "${HISTORY_FILES[@]}"; do
  if [[ -f "$hist_file" ]]; then
    shell_name=$(basename "$hist_file" | cut -d_ -f1 | cut -d. -f2)

    # Create temporary file for cleaned history (born clean, VPN lines never written to it)
    temp_hist=$(mktemp)

    # Remove lines containing VPN-related keywords
    # Use case-insensitive grep to catch variations
    if grep -vEi "lazyvpn|wireguard|$INTERFACE_NAME_ESCAPED|\.conf.*proton|\.conf.*mullvad|\.conf.*ivpn" "$hist_file" > "$temp_hist" 2>/dev/null; then
      # Check if any lines were actually removed
      original_lines=$(wc -l < "$hist_file")
      cleaned_lines=$(wc -l < "$temp_hist")
      removed_lines=$((original_lines - cleaned_lines))

      if [[ $removed_lines -gt 0 ]]; then
        # Securely delete the original file (contains VPN commands)
        if secure_delete "$hist_file"; then
          mv "$temp_hist" "$hist_file"
          echo "  ✓ Cleaned $shell_name history: securely removed $removed_lines line(s)"
        else
          # secure_delete failed or user cancelled - still overwrite to remove VPN evidence
          mv "$temp_hist" "$hist_file"
          echo "  ✓ Cleaned $shell_name history: removed $removed_lines line(s) (overwrite only)"
        fi
        ((cleaned_count++))
      else
        # No VPN commands found - clean up temp file
        secure_delete "$temp_hist"
        echo "  - $shell_name history: no VPN commands found"
        ((skipped_count++))
      fi
    else
      # Grep failed, preserve original - clean up temp file
      secure_delete "$temp_hist"
      echo "  ✗ Failed to clean $shell_name history"
    fi
  fi
done

if [[ $cleaned_count -eq 0 ]] && [[ $skipped_count -eq 0 ]]; then
  echo "  - No shell history files found"
else
  echo ""
  echo "  Summary: Cleaned $cleaned_count history file(s), $skipped_count had no VPN commands"
fi
echo ""

echo "======================================="
echo "  Uninstallation Complete"
echo "======================================="
echo "LazyVPN has been removed from your system."
echo "Thank you for using LazyVPN!"
