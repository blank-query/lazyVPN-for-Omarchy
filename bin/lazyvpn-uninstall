#!/bin/bash

# LazyVPN Uninstallation Script

echo "======================================="
echo "  LazyVPN Uninstaller"
echo "======================================="
echo ""

# --- Define Paths ---
OMARCHY_BIN="$HOME/.local/share/omarchy/bin"
CONFIG_DIR="$HOME/.config/lazyvpn"
AUTOSTART_FILE="$HOME/.config/autostart/lazyvpn.desktop"
OMARCHY_MENU_FILE="$OMARCHY_BIN/omarchy-menu"
OMARCHY_MENU_BACKUP="$OMARCHY_MENU_FILE.backup"

# --- Check for active VPN connection ---
echo "Checking for active VPN connection..."
CONNECTION_NAME="wg0"  # Default

# Source common functions if available (for is_connected check)
if [[ -f "$OMARCHY_BIN/lazyvpn-common" ]]; then
  # shellcheck source=/dev/null
  source "$OMARCHY_BIN/lazyvpn-common"
fi

if [[ -f "$CONFIG_DIR/config" ]]; then
  # Load connection name from config if it exists
  source "$CONFIG_DIR/config" 2>/dev/null
  CONNECTION_NAME="${CONNECTION_NAME:-wg0}"
fi

# Check if VPN is actually connected (not just if interface exists)
VPN_CONNECTED=false
if type is_connected &>/dev/null && is_connected "$CONNECTION_NAME"; then
  VPN_CONNECTED=true
elif ip link show "$CONNECTION_NAME" &>/dev/null; then
  # Fallback: check if interface exists and has state routable/degraded
  state=$(networkctl status "$CONNECTION_NAME" 2>/dev/null | grep -E "^\s*State:" | awk '{print $2}')
  if [[ "$state" == "routable" ]] || [[ "$state" == "degraded" ]]; then
    VPN_CONNECTED=true
  fi
fi

if [[ "$VPN_CONNECTED" == "true" ]]; then
  echo ""
  echo "⚠️  WARNING: VPN connection is currently ACTIVE!"
  echo ""
  echo "You are currently connected to a VPN server."
  echo "If you uninstall while connected, you may experience:"
  echo "  • Loss of internet connectivity"
  echo "  • Difficulty disconnecting from the VPN"
  echo "  • Network routing issues"
  echo ""
  read -r -p "Disconnect from VPN before uninstalling? [Y/n] " disconnect_choice

  if [[ ! "$disconnect_choice" =~ ^[Nn]$ ]]; then
    echo ""
    echo "Disconnecting from VPN..."

    # Try to use the disconnect script if it exists
    if [[ -x "$OMARCHY_BIN/lazyvpn-disconnect" ]]; then
      "$OMARCHY_BIN/lazyvpn-disconnect" 2>/dev/null
    else
      # Manual disconnect if script not available
      echo "  - Removing systemd-networkd configuration files..."
      sudo rm -f "/etc/systemd/network/99-${CONNECTION_NAME}.netdev" 2>/dev/null
      sudo rm -f "/etc/systemd/network/99-${CONNECTION_NAME}.network" 2>/dev/null

      echo "  - Removing VPN interface..."
      sudo ip link delete "$CONNECTION_NAME" 2>/dev/null || true

      echo "  - Restarting systemd-networkd..."
      sudo systemctl restart systemd-networkd
    fi

    echo "  ✓ Disconnected successfully"
    sleep 2
  else
    echo ""
    echo "⚠️  Proceeding with uninstall while VPN is connected."
    echo "   You may need to manually disconnect after uninstall:"
    echo "   sudo ip link delete $CONNECTION_NAME"
    echo "   sudo rm -f /etc/systemd/network/99-${CONNECTION_NAME}.*"
    echo "   sudo systemctl restart systemd-networkd"
    echo ""
    read -r -p "Press Enter to continue with uninstall..."
  fi
else
  echo "  - No active VPN connection detected."
fi
echo ""

# --- User Choice for WireGuard Configs ---
WG_CONFIG_DIR="$CONFIG_DIR/wireguard"
echo "Your WireGuard server configurations are stored in:"
echo "$WG_CONFIG_DIR"
echo ""

delete_configs="n" # Default to not deleting configs

if [[ -d "$WG_CONFIG_DIR" ]] && ls "$WG_CONFIG_DIR"/*.conf 1>/dev/null 2>&1; then
  echo "The following WireGuard config files were found:"
  ls -1 "$WG_CONFIG_DIR"/*.conf | sed "s|^$WG_CONFIG_DIR/|  - |"
  echo ""
  read -r -p "Do you want to DELETE these .conf files? (This cannot be undone) [y/N] " delete_configs
  if [[ "$delete_configs" =~ ^[Yy]$ ]]; then
    echo "-> WireGuard configs will be permanently deleted."
  else
    echo "-> WireGuard configs will be kept."
  fi
else
  echo "No WireGuard config files found."
  echo "-> No WireGuard configs to delete."
fi
echo ""

# --- Step 1: Clean up iptables rules ---
echo "Step 1: Cleaning up firewall rules..."

# Check if killswitch was ever used by looking for the KILLSWITCH key in config
KILLSWITCH_CONFIGURED=false
if [[ -f "$CONFIG_DIR/config" ]] && grep -q "^KILLSWITCH=" "$CONFIG_DIR/config"; then
  KILLSWITCH_CONFIGURED=true
fi

if [[ "$KILLSWITCH_CONFIGURED" == "true" ]]; then
  # Killswitch was configured at some point, check if rules exist (requires sudo)
  if sudo iptables -L LAZYVPN_OUT >/dev/null 2>&1; then
    echo "  - Found existing firewall rules. Removing them..."
    sudo iptables -D OUTPUT -j LAZYVPN_OUT 2>/dev/null && echo "    - Removed IPv4 OUTPUT jump"
    sudo ip6tables -D OUTPUT -j LAZYVPN_OUT 2>/dev/null && echo "    - Removed IPv6 OUTPUT jump"
    sudo iptables -F LAZYVPN_OUT 2>/dev/null && echo "    - Flushed LAZYVPN_OUT chain"
    sudo ip6tables -F LAZYVPN_OUT 2>/dev/null && echo "    - Flushed LAZYVPN_OUT chain (IPv6)"
    sudo iptables -X LAZYVPN_OUT 2>/dev/null && echo "    - Deleted LAZYVPN_OUT chain"
    sudo ip6tables -X LAZYVPN_OUT 2>/dev/null && echo "    - Deleted LAZYVPN_OUT chain (IPv6)"
    echo "  Firewall cleanup complete."
  else
    echo "  - No LazyVPN firewall rules found (already removed)."
  fi
else
  echo "  - Killswitch was never configured, skipping firewall cleanup."
fi
echo ""

# --- Step 2: Remove LazyVPN scripts ---
echo "Step 2: Removing LazyVPN scripts..."
scripts_to_remove=("$OMARCHY_BIN"/lazyvpn-*)
if [[ -e "${scripts_to_remove[0]}" ]]; then # Check if the glob expanded to existing files
  for script in "${scripts_to_remove[@]}"; do
    if [[ -f "$script" ]]; then
      rm -f "$script"
      echo "  - Removed: $(basename "$script")"
    fi
  done
else
  echo "  - No scripts found to remove."
fi
echo ""

# --- Step 3: Remove LazyVPN from omarchy-menu ---
echo "Step 3: Removing LazyVPN integration from omarchy-menu..."

# Check if LazyVPN is integrated
if grep -q "LazyVPN" "$OMARCHY_MENU_FILE"; then
  # Try surgical removal with AWK
  if awk '
    # Skip the show_lazyvpn_menu function and its blank line after
    /^show_lazyvpn_menu\(\) \{/ {
      getline  # skip the lazyvpn-menu line
      getline  # skip the }
      getline  # skip the blank line after
      next
    }

    # Remove LazyVPN from the menu options string
    /menu "Go" ".*LazyVPN/ {
      gsub(/󰖂  LazyVPN\\n/, "")
    }

    # Skip the lazyvpn case handler line
    /^\s*\*lazyvpn\*\) show_lazyvpn_menu ;;/ {
      next
    }

    # Print all other lines
    { print }
  ' "$OMARCHY_MENU_FILE" > "$OMARCHY_MENU_FILE.tmp"; then
    # AWK succeeded, apply changes
    mv "$OMARCHY_MENU_FILE.tmp" "$OMARCHY_MENU_FILE" && chmod +x "$OMARCHY_MENU_FILE"
    echo "  - Removed LazyVPN integration from omarchy-menu"
  else
    # AWK failed, restore from backup if available
    echo "  - Surgical removal failed, attempting restore from backup..."
    if [[ -f "$OMARCHY_MENU_BACKUP" ]]; then
      cp "$OMARCHY_MENU_BACKUP" "$OMARCHY_MENU_FILE"
      chmod +x "$OMARCHY_MENU_FILE"
      echo "  - Restored omarchy-menu from backup"
    else
      echo "  ⚠ WARNING: Backup not found. omarchy-menu may need manual repair."
      echo "  You can restore Omarchy by reinstalling it."
    fi
    rm -f "$OMARCHY_MENU_FILE.tmp"
  fi

  echo "  - Restarting menu to apply changes..."
  nohup omarchy-restart-walker > /dev/null 2>&1 &
else
  echo "  - LazyVPN not found in omarchy-menu (already removed or never installed)"
fi
echo ""

# --- Step 4: Remove keyboard shortcut ---
echo "Step 4: Removing keyboard shortcut..."

# Remove from Hyprland bindings
HYPR_BINDINGS="$HOME/.config/hypr/bindings.conf"
if [[ -f "$HYPR_BINDINGS" ]]; then
  if grep -q "LazyVPN" "$HYPR_BINDINGS"; then
    # Remove the LazyVPN comment and keybinding lines
    sed -i '/# LazyVPN/d' "$HYPR_BINDINGS"
    sed -i '/bindd = SUPER, L, LazyVPN/d' "$HYPR_BINDINGS"
    echo "  - Removed SUPER+L keybinding from Hyprland"

    # Reload Hyprland config
    hyprctl reload >/dev/null 2>&1
    echo "  - Reloaded Hyprland configuration"
  else
    echo "  - No LazyVPN keybinding found in Hyprland config"
  fi
else
  echo "  - Hyprland bindings.conf not found"
fi

# Remove from keybindings helper
KEYBINDINGS_SCRIPT="$OMARCHY_BIN/omarchy-menu-keybindings"
if [[ -f "$KEYBINDINGS_SCRIPT" ]]; then
  if grep -q "LazyVPN" "$KEYBINDINGS_SCRIPT"; then
    sed -i '/echo "SUPER,L,LazyVPN,exec,lazyvpn-menu"/d' "$KEYBINDINGS_SCRIPT"
    echo "  - Removed from keybindings helper"
  else
    echo "  - No LazyVPN entry found in keybindings helper"
  fi
else
  echo "  - Keybindings script not found"
fi
echo ""

# --- Step 5: Remove Autostart entry ---
echo "Step 5: Removing Autostart entry..."
if [[ -f "$AUTOSTART_FILE" ]]; then
  rm -f "$AUTOSTART_FILE"
  echo "  - Removed autostart file."
else
  echo "  - No autostart file found."
fi
echo ""

# --- Step 6: Securely Remove Performance History ---
echo "Step 6: Securely removing performance history..."
PERF_DIR="$CONFIG_DIR/performance"
if [[ -d "$PERF_DIR" ]] && ls "$PERF_DIR"/*.log 1>/dev/null 2>&1; then
  echo "  - Performance history contains usage metadata. Securely deleting..."
  shredded_count=0
  for log_file in "$PERF_DIR"/*.log; do
    if shred -u "$log_file" 2>/dev/null; then
      ((shredded_count++))
    else
      rm -f "$log_file"  # Fallback to regular deletion
    fi
  done
  echo "    ✓ Securely deleted $shredded_count performance log(s)"
  rmdir "$PERF_DIR" 2>/dev/null  # Remove empty directory
else
  echo "  - No performance history found."
fi
echo ""

# --- Step 7: Securely Remove LazyVPN Config Files ---
echo "Step 7: Securely removing LazyVPN configuration files..."
if [[ ! -d "$CONFIG_DIR" ]]; then
  echo "  - Configuration directory not found."
else
  # Securely delete LazyVPN's own config files (not server configs)
  echo "  - Securely deleting LazyVPN config and cache files..."
  shredded_count=0
  for config_file in "$CONFIG_DIR"/config "$CONFIG_DIR"/.server-list-cache; do
    if [[ -f "$config_file" ]]; then
      if shred -u "$config_file" 2>/dev/null; then
        echo "    ✓ Securely deleted: $(basename "$config_file")"
        ((shredded_count++))
      else
        rm -f "$config_file"  # Fallback to regular deletion
      fi
    fi
  done

  # Handle WireGuard server configs based on user choice
  if [[ "$delete_configs" =~ ^[Yy]$ ]]; then
    # User wants to delete server configs - shred them
    if [[ -d "$WG_CONFIG_DIR" ]] && ls "$WG_CONFIG_DIR"/*.conf 1>/dev/null 2>&1; then
      echo "  - Securely deleting WireGuard server configs..."
      for conf_file in "$WG_CONFIG_DIR"/*.conf; do
        if shred -u "$conf_file" 2>/dev/null; then
          echo "    ✓ Securely deleted: $(basename "$conf_file")"
        else
          echo "    ✗ Failed to securely delete: $(basename "$conf_file")"
          rm -f "$conf_file"  # Fallback to regular deletion
        fi
      done
    fi
    # Remove the entire config directory
    rm -rf "$CONFIG_DIR"
    echo "  - Removed entire configuration directory: $CONFIG_DIR"
  else
    # User wants to keep server configs - preserve wireguard folder
    echo "  - Preserved WireGuard server configs in: $WG_CONFIG_DIR"
  fi
fi
echo ""

# --- Step 7: Clean up systemd-networkd files ---
echo "Step 7: Cleaning up systemd-networkd configuration..."
NETDEV_FILE="/etc/systemd/network/99-${CONNECTION_NAME}.netdev"
NETWORK_FILE="/etc/systemd/network/99-${CONNECTION_NAME}.network"

if [[ -f "$NETDEV_FILE" ]] || [[ -f "$NETWORK_FILE" ]]; then
  echo "  - Found leftover systemd-networkd files. Securely deleting..."
  if [[ -f "$NETDEV_FILE" ]]; then
    if sudo shred -u "$NETDEV_FILE" 2>/dev/null; then
      echo "    ✓ Securely deleted: $NETDEV_FILE"
    else
      sudo rm -f "$NETDEV_FILE" 2>/dev/null  # Fallback
      echo "    - Removed: $NETDEV_FILE"
    fi
  fi
  if [[ -f "$NETWORK_FILE" ]]; then
    if sudo shred -u "$NETWORK_FILE" 2>/dev/null; then
      echo "    ✓ Securely deleted: $NETWORK_FILE"
    else
      sudo rm -f "$NETWORK_FILE" 2>/dev/null  # Fallback
      echo "    - Removed: $NETWORK_FILE"
    fi
  fi

  # Check if interface still exists
  if ip link show "$CONNECTION_NAME" &>/dev/null; then
    echo "  - VPN interface still exists. Removing..."
    sudo ip link delete "$CONNECTION_NAME" 2>/dev/null && echo "    - Removed interface: $CONNECTION_NAME"
  fi

  echo "  - Restarting systemd-networkd to apply changes..."
  sudo systemctl restart systemd-networkd
  echo "  - Systemd-networkd cleanup complete."
else
  echo "  - No systemd-networkd files found to clean up."
fi
echo ""

# --- Step 8: Remove sudoers configuration ---
echo "Step 8: Removing sudoers configuration..."
if sudo test -f /etc/sudoers.d/lazyvpn; then
  if sudo rm -f /etc/sudoers.d/lazyvpn; then
    # Verify it's actually gone
    if sudo test -f /etc/sudoers.d/lazyvpn; then
      echo "  ⚠ WARNING: Failed to remove sudoers file!"
      echo "  Please manually remove: sudo rm /etc/sudoers.d/lazyvpn"
    else
      echo "  ✓ Removed sudoers configuration"
    fi
  else
    echo "  ⚠ ERROR: Failed to remove sudoers configuration"
    echo "  Please manually remove: sudo rm /etc/sudoers.d/lazyvpn"
  fi
else
  echo "  - No sudoers configuration found"
fi
echo ""

# --- Step 9: Clean up system logs (surgical approach) ---
echo "Step 9: System log cleanup (optional)..."
echo ""
echo "═══════════════════════════════════════════════════════════"
echo "  Privacy Note: System Logs"
echo "═══════════════════════════════════════════════════════════"
echo ""
echo "LazyVPN connection history may exist in systemd journal logs."
echo "These logs contain:"
echo "  • Timestamps of VPN connections/disconnections"
echo "  • Interface names (e.g., ${CONNECTION_NAME:-wg0})"
echo "  • Configuration file paths"
echo ""
echo "LazyVPN can surgically identify and securely delete ONLY the"
echo "journal files containing VPN logs, preserving other system logs."
echo ""
echo "⚠️  WARNING: This will:"
echo "   • Stop systemd-journald temporarily"
echo "   • Shred journal files containing VPN connection history"
echo "   • Preserve journal files from periods without VPN activity"
echo "   • Restart systemd-journald"
echo ""
read -r -p "Securely remove journal files containing VPN logs? [y/N]: " clear_logs

if [[ "$clear_logs" =~ ^[Yy]$ ]]; then
  echo ""
  echo "  - Scanning journal files for VPN activity..."

  # Get machine ID for journal directory
  MACHINE_ID=$(cat /etc/machine-id 2>/dev/null)
  if [[ -z "$MACHINE_ID" ]]; then
    echo "    ✗ Failed to read machine-id"
  else
    JOURNAL_DIR="/var/log/journal/$MACHINE_ID"
    if [[ ! -d "$JOURNAL_DIR" ]]; then
      JOURNAL_DIR="/run/log/journal/$MACHINE_ID"
    fi

    if [[ ! -d "$JOURNAL_DIR" ]]; then
      echo "    ✗ Journal directory not found"
    else
      # Find all system journal files and check for VPN logs
      VPN_JOURNALS=()
      INTERFACE_NAME="${CONNECTION_NAME:-wg0}"

      for journal_file in "$JOURNAL_DIR"/system*.journal; do
        if [[ -f "$journal_file" ]]; then
          # Check if this journal contains VPN logs
          if journalctl --file="$journal_file" -u systemd-networkd --no-pager 2>/dev/null | grep -q "$INTERFACE_NAME"; then
            VPN_JOURNALS+=("$journal_file")
          fi
        fi
      done

      TOTAL_JOURNALS=$(find "$JOURNAL_DIR" -name "system*.journal" -type f | wc -l)
      VPN_COUNT=${#VPN_JOURNALS[@]}

      echo "    Found VPN logs in $VPN_COUNT of $TOTAL_JOURNALS system journal files"

      if [[ $VPN_COUNT -eq 0 ]]; then
        echo "    ✓ No VPN logs found in journal files"
      else
        echo ""
        echo "  - Stopping systemd-journald..."
        if sudo systemctl stop systemd-journald 2>/dev/null; then
          echo "    ✓ Stopped systemd-journald"

          echo ""
          echo "  - Securely deleting journal files with VPN logs..."
          shredded=0
          failed=0

          for journal_file in "${VPN_JOURNALS[@]}"; do
            filename=$(basename "$journal_file")
            if sudo shred -u "$journal_file" 2>/dev/null; then
              echo "    ✓ Securely deleted: $filename"
              ((shredded++))
            else
              echo "    ✗ Failed to shred: $filename"
              ((failed++))
            fi
          done

          echo ""
          echo "  - Restarting systemd-journald..."
          sudo systemctl start systemd-journald 2>/dev/null
          sleep 1

          if systemctl is-active --quiet systemd-journald; then
            echo "    ✓ systemd-journald restarted successfully"
            echo ""
            echo "    Summary:"
            echo "      • Securely deleted: $shredded journal file(s)"
            if [[ $failed -gt 0 ]]; then
              echo "      • Failed: $failed journal file(s)"
            fi
            clean_count=$((TOTAL_JOURNALS - VPN_COUNT))
            echo "      • Preserved: $clean_count journal file(s) without VPN logs"
          else
            echo "    ✗ Failed to restart systemd-journald"
            echo "    Please manually start it: sudo systemctl start systemd-journald"
          fi
        else
          echo "    ✗ Failed to stop systemd-journald"
        fi
      fi
    fi
  fi
else
  echo ""
  echo "  - System logs preserved."
  echo ""
  echo "To manually clear VPN logs later, you would need to:"
  echo "  1. Identify journal files containing VPN logs"
  echo "  2. Stop systemd-journald"
  echo "  3. Securely delete those files"
  echo "  4. Restart systemd-journald"
fi
echo ""

# --- Step 10: Clean up shell history ---
echo "Step 10: Cleaning shell history..."
echo ""
echo "Removing VPN-related commands from shell history files..."

INTERFACE_NAME="${CONNECTION_NAME:-wg0}"
cleaned_count=0
skipped_count=0

# List of common shell history files
HISTORY_FILES=(
  "$HOME/.bash_history"
  "$HOME/.zsh_history"
  "$HOME/.local/share/fish/fish_history"
)

for hist_file in "${HISTORY_FILES[@]}"; do
  if [[ -f "$hist_file" ]]; then
    shell_name=$(basename "$hist_file" | cut -d_ -f1 | cut -d. -f2)

    # Create temporary file for cleaned history (born clean, VPN lines never written to it)
    temp_hist=$(mktemp)

    # Remove lines containing VPN-related keywords
    # Use case-insensitive grep to catch variations
    if grep -vEi "lazyvpn|wireguard|$INTERFACE_NAME|\.conf.*proton|\.conf.*mullvad|\.conf.*ivpn" "$hist_file" > "$temp_hist" 2>/dev/null; then
      # Check if any lines were actually removed
      original_lines=$(wc -l < "$hist_file")
      cleaned_lines=$(wc -l < "$temp_hist")
      removed_lines=$((original_lines - cleaned_lines))

      if [[ $removed_lines -gt 0 ]]; then
        # Securely delete the original file (contains VPN commands)
        if shred -u "$hist_file" 2>/dev/null; then
          # Replace with cleaned version
          mv "$temp_hist" "$hist_file"
          echo "  ✓ Cleaned $shell_name history: securely removed $removed_lines line(s)"
          ((cleaned_count++))
        else
          # Shred failed, fallback to regular replacement
          mv "$temp_hist" "$hist_file"
          echo "  ✓ Cleaned $shell_name history: removed $removed_lines line(s) (shred unavailable)"
          ((cleaned_count++))
        fi
      else
        # No VPN commands found
        rm -f "$temp_hist"
        echo "  - $shell_name history: no VPN commands found"
        ((skipped_count++))
      fi
    else
      # Grep failed, preserve original
      rm -f "$temp_hist"
      echo "  ✗ Failed to clean $shell_name history"
    fi
  fi
done

if [[ $cleaned_count -eq 0 ]] && [[ $skipped_count -eq 0 ]]; then
  echo "  - No shell history files found"
else
  echo ""
  echo "  Summary: Cleaned $cleaned_count history file(s), $skipped_count had no VPN commands"
fi
echo ""

echo "======================================="
echo "  Uninstallation Complete"
echo "======================================="
echo "LazyVPN has been removed from your system."
echo "Thank you for using LazyVPN!"
