#!/bin/bash

# Get detailed server information from WireGuard config

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lazyvpn-common" || exit 1
# shellcheck source=./lazyvpn-common

SERVER_NAME="$1"

# Validate server name to prevent path traversal
if [[ ! "$SERVER_NAME" =~ ^[a-zA-Z0-9._#-]+$ ]]; then
  echo "error=Invalid server name"
  exit 1
fi

# Prevent path traversal
if [[ "$SERVER_NAME" == *".."* ]] || [[ "$SERVER_NAME" == "/"* ]]; then
  echo "error=Invalid server name"
  exit 1
fi

WG_DIR="$HOME/.config/lazyvpn/wireguard"
CONFIG_FILE="$WG_DIR/${SERVER_NAME}.conf"

if [[ ! -f "$CONFIG_FILE" ]]; then
  echo "error=Server config not found"
  exit 1
fi

# Parse configuration file
endpoint=$(grep -m1 "^Endpoint" "$CONFIG_FILE" | cut -d= -f2 | tr -d ' ')
server_ip=$(echo "$endpoint" | cut -d: -f1)
server_port=$(echo "$endpoint" | cut -d: -f2)

# Try to extract DNS servers
dns=$(grep -m1 "^DNS" "$CONFIG_FILE" | cut -d= -f2 | tr -d ' ')

# Detect VPN provider (check filename first, then config contents)
provider=$(detect_provider_from_name "$SERVER_NAME")
if [[ -z "$provider" ]]; then
  local_id=$(detect_provider "$CONFIG_FILE")
  if [[ -n "$local_id" ]]; then
    provider="${PROVIDER_DISPLAY[$local_id]}"
  fi
fi

# Parse filename for location info
# Strip provider prefix if present (e.g., Proton-US-NY#1 â†’ US-NY#1)
PARSE_NAME="$SERVER_NAME"
if [[ "$PARSE_NAME" =~ ^(Proton|Mullvad|IVPN|PIA|Nord|Surf|wg|vpn|server|conf)- ]]; then
  PARSE_NAME="${PARSE_NAME#*-}"
fi

# Format examples generated by our naming system:
#   US-DC-Washington#1 (country-state-city-number)
#   US-NY#123 (country-state-number)
#   SE-Stockholm#130 (country-city-number)
#   SE#130 (country-number)
#   US-DC-Washington-P2P#1 (with features)
state=""
number=""

# Parse location patterns (most specific first)
if [[ "$PARSE_NAME" =~ ^([A-Z]{2})-([A-Z]{2})-([A-Za-z]+)-?([A-Za-z0-9-]+)?#([0-9]+)$ ]]; then
  # Format: US-DC-Washington#1 or US-DC-Washington-P2P#1
  country="${BASH_REMATCH[1]}"
  state="${BASH_REMATCH[2]}"
  city="${BASH_REMATCH[3]}"
  # BASH_REMATCH[4] is optional features
  number="${BASH_REMATCH[5]}"
elif [[ "$PARSE_NAME" =~ ^([A-Z]{2})-([A-Z]{2})-?([A-Za-z0-9-]+)?#([0-9]+)$ ]]; then
  # Format: US-NY#123 or US-NY-P2P#456 (country-state-[features]-number)
  country="${BASH_REMATCH[1]}"
  state="${BASH_REMATCH[2]}"
  # BASH_REMATCH[3] is optional features or could be city
  number="${BASH_REMATCH[4]}"
elif [[ "$PARSE_NAME" =~ ^([A-Z]{2})-([A-Za-z]+)-?([A-Za-z0-9-]+)?#([0-9]+)$ ]]; then
  # Format: SE-Stockholm#130 or SE-Stockholm-P2P#456 (country-city-[features]-number)
  country="${BASH_REMATCH[1]}"
  city="${BASH_REMATCH[2]}"
  # BASH_REMATCH[3] is optional features
  number="${BASH_REMATCH[4]}"
elif [[ "$PARSE_NAME" =~ ^([A-Z]{2})#([0-9]+)$ ]]; then
  # Format: SE#130 (country-number)
  country="${BASH_REMATCH[1]}"
  number="${BASH_REMATCH[2]}"
elif [[ "$PARSE_NAME" =~ ^([A-Z]{2})-([0-9]+)$ ]]; then
  # Format: SE-130 (country-number, old style)
  country="${BASH_REMATCH[1]}"
  number="${BASH_REMATCH[2]}"
else
  # Fallback: use the whole filename
  country="Unknown"
  city=""
  number=""
fi

# Determine services (VPN features)
# Check filename and config file for feature indicators
services=""

# Get the Peer comment line which often has server designation
peer_comment=$(grep -m1 "^# .*#[0-9]" "$CONFIG_FILE" 2>/dev/null | tr -d '#' | tr -d ' ')

# Check for P2P support
if [[ "$SERVER_NAME" =~ [Pp]2[Pp] ]] || [[ "$peer_comment" =~ [Pp]2[Pp] ]] || grep -qiw "p2p" "$CONFIG_FILE" 2>/dev/null; then
  services="${services:+$services,}p2p"
fi

# Check for Tor support
if [[ "$SERVER_NAME" =~ -[Tt][Oo][Rr]- ]] || [[ "$SERVER_NAME" =~ -[Tt][Oo][Rr]$ ]] || [[ "$SERVER_NAME" =~ ^[Tt][Oo][Rr]- ]] || \
   [[ "$peer_comment" =~ -[Tt][Oo][Rr]$ ]] || [[ "$peer_comment" =~ [Tt][Oo][Rr]- ]]; then
  services="${services:+$services,}tor"
fi

# Check for Secure Core (ProtonVPN multi-hop feature)
# Secure Core uses format: [ENTRY_COUNTRY]-[EXIT_COUNTRY]#[NUMBER]
# Entry countries are always CH (Switzerland), IS (Iceland), or SE (Sweden)
# peer_comment has # and spaces removed, so "SE-RO#1" becomes "SE-RO1"
if [[ "$peer_comment" =~ ^(CH|IS|SE)-([A-Z]{2})[0-9] ]]; then
  # Double-check the second part is a valid country code, not TOR/FREE/etc
  exit_country="${BASH_REMATCH[2]}"
  if [[ ! "$exit_country" =~ ^(TO|FR|SC)$ ]]; then
    services="${services:+$services,}securecore"
  fi
fi
# Also check filename/config for explicit Secure Core markers
if [[ "$SERVER_NAME" =~ [Ss]ecure[_-]?[Cc]ore ]] || grep -qiE 'secure.core|securecore' "$CONFIG_FILE" 2>/dev/null; then
  services="${services:+$services,}securecore"
fi

# Check for Streaming support
if [[ "$SERVER_NAME" =~ [Ss]treaming ]] || [[ "$SERVER_NAME" =~ [Ss]tream ]] || \
   [[ "$peer_comment" =~ [Ss]treaming ]] || grep -qiw "streaming" "$CONFIG_FILE" 2>/dev/null; then
  services="${services:+$services,}streaming"
fi

# Check for P2P support (via NAT-PMP Port Forwarding)
# P2P and Port Forwarding are the same feature
if grep -q "^# NAT-PMP.*= on" "$CONFIG_FILE" 2>/dev/null; then
  services="${services:+$services,}p2p"
fi

# Check for VPN Accelerator
if grep -q "^# VPN Accelerator.*= on" "$CONFIG_FILE" 2>/dev/null; then
  services="${services:+$services,}accelerator"
fi

# Check for NetShield (ad/tracker/malware blocking)
# Level 0 = off, Level 1 = malware only, Level 2 = malware + ads
netshield_level=$(grep "^# NetShield" "$CONFIG_FILE" 2>/dev/null | grep -oE "[0-9]+" | head -1)
if [[ -n "$netshield_level" ]] && [[ "$netshield_level" -eq 1 ]]; then
  services="${services:+$services,}netshield1"
elif [[ -n "$netshield_level" ]] && [[ "$netshield_level" -eq 2 ]]; then
  services="${services:+$services,}netshield2"
fi

# Check for Moderate NAT (gaming/P2P optimized)
if grep -q "^# Moderate NAT.*= on" "$CONFIG_FILE" 2>/dev/null; then
  services="${services:+$services,}moderatenat"
fi

# Check for Free tier servers
if [[ "$SERVER_NAME" =~ [Ff]ree ]] || [[ "$peer_comment" =~ [Ff][Rr][Ee][Ee] ]]; then
  services="${services:+$services,}free"
fi

# Default to standard if no special features detected
if [[ -z "$services" ]]; then
  services="standard"
fi

echo "name=$SERVER_NAME"
echo "country=$country"
echo "state=$state"
echo "city=$city"
echo "number=$number"
echo "endpoint=$endpoint"
echo "server_ip=$server_ip"
echo "server_port=$server_port"
echo "dns=$dns"
echo "services=$services"
echo "provider=$provider"
