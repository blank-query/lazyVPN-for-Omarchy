#!/bin/bash

# Get detailed server information from WireGuard config

SERVER_NAME="$1"

# Validate server name to prevent path traversal
# shellcheck source=./lazyvpn-common
if [[ ! "$SERVER_NAME" =~ ^[a-zA-Z0-9._#-]+$ ]]; then
  echo "error=Invalid server name"
  exit 1
fi

# Prevent path traversal
if [[ "$SERVER_NAME" == *".."* ]] || [[ "$SERVER_NAME" == "/"* ]]; then
  echo "error=Invalid server name"
  exit 1
fi

WG_DIR="$HOME/.config/lazyvpn/wireguard"
CONFIG_FILE="$WG_DIR/${SERVER_NAME}.conf"

if [[ ! -f "$CONFIG_FILE" ]]; then
  echo "error=Server config not found"
  exit 1
fi

# Parse configuration file
endpoint=$(grep -m1 "^Endpoint" "$CONFIG_FILE" | cut -d= -f2 | tr -d ' ')
server_ip=$(echo "$endpoint" | cut -d: -f1)
server_port=$(echo "$endpoint" | cut -d: -f2)

# Try to extract DNS servers
dns=$(grep -m1 "^DNS" "$CONFIG_FILE" | cut -d= -f2 | tr -d ' ')

# Detect VPN provider
provider=""

# Method 1: Check filename prefix
if [[ "$SERVER_NAME" =~ ^(proton|mullvad|ivpn|pia|nordvpn|surfshark|expressvpn|windscribe)- ]]; then
  case "${BASH_REMATCH[1],,}" in
    proton) provider="ProtonVPN" ;;
    mullvad) provider="Mullvad" ;;
    ivpn) provider="IVPN" ;;
    pia) provider="PIA" ;;
    nordvpn) provider="NordVPN" ;;
    surfshark) provider="Surfshark" ;;
    expressvpn) provider="ExpressVPN" ;;
    windscribe) provider="Windscribe" ;;
  esac
fi

# Method 2: Check endpoint domain if no prefix found
if [[ -z "$provider" ]]; then
  if [[ "$endpoint" =~ protonvpn\.com|protonvpn\.net ]]; then
    provider="ProtonVPN"
  elif [[ "$endpoint" =~ mullvad\.net ]]; then
    provider="Mullvad"
  elif [[ "$endpoint" =~ ivpn\.net ]]; then
    provider="IVPN"
  elif [[ "$endpoint" =~ privateinternetaccess\.com ]]; then
    provider="PIA"
  elif [[ "$endpoint" =~ nordvpn\.com ]]; then
    provider="NordVPN"
  elif [[ "$endpoint" =~ surfshark\.com ]]; then
    provider="Surfshark"
  elif [[ "$endpoint" =~ expressvpn\.com ]]; then
    provider="ExpressVPN"
  elif [[ "$endpoint" =~ windscribe\.com ]]; then
    provider="Windscribe"
  fi
fi

# Method 3: Check DNS servers if still unknown
if [[ -z "$provider" && -n "$dns" ]]; then
  case "$dns" in
    10.2.0.1) provider="ProtonVPN" ;;
    10.64.0.1|193.138.218.74) provider="Mullvad" ;;
    172.16.0.1) provider="IVPN" ;;
    10.0.0.241|10.0.0.242) provider="PIA" ;;
  esac
fi

# Method 4: Check comments in config file
if [[ -z "$provider" ]]; then
  if grep -qi "protonvpn" "$CONFIG_FILE"; then
    provider="ProtonVPN"
  elif grep -qi "mullvad" "$CONFIG_FILE"; then
    provider="Mullvad"
  elif grep -qi "ivpn" "$CONFIG_FILE"; then
    provider="IVPN"
  fi
fi

# Parse filename for location info
# Strip provider prefix if present (e.g., Proton-US-NY#1 â†’ US-NY#1)
PARSE_NAME="$SERVER_NAME"
if [[ "$PARSE_NAME" =~ ^(Proton|Mullvad|IVPN|PIA|Nord|Surf|wg|vpn|server|conf)- ]]; then
  PARSE_NAME="${PARSE_NAME#*-}"
fi

# Format examples generated by our naming system:
#   US-DC-Washington#1 (country-state-city-number)
#   US-NY#123 (country-state-number)
#   SE-Stockholm#130 (country-city-number)
#   SE#130 (country-number)
#   US-DC-Washington-P2P#1 (with features)
state=""
number=""

# Parse location patterns (most specific first)
if [[ "$PARSE_NAME" =~ ^([A-Z]{2})-([A-Z]{2})-([A-Za-z]+)-?([A-Za-z0-9-]+)?#([0-9]+)$ ]]; then
  # Format: US-DC-Washington#1 or US-DC-Washington-P2P#1
  country="${BASH_REMATCH[1]}"
  state="${BASH_REMATCH[2]}"
  city="${BASH_REMATCH[3]}"
  # BASH_REMATCH[4] is optional features
  number="${BASH_REMATCH[5]}"
elif [[ "$PARSE_NAME" =~ ^([A-Z]{2})-([A-Z]{2})-?([A-Za-z0-9-]+)?#([0-9]+)$ ]]; then
  # Format: US-NY#123 or US-NY-P2P#456 (country-state-[features]-number)
  country="${BASH_REMATCH[1]}"
  state="${BASH_REMATCH[2]}"
  # BASH_REMATCH[3] is optional features or could be city
  number="${BASH_REMATCH[4]}"
elif [[ "$PARSE_NAME" =~ ^([A-Z]{2})-([A-Za-z]+)-?([A-Za-z0-9-]+)?#([0-9]+)$ ]]; then
  # Format: SE-Stockholm#130 or SE-Stockholm-P2P#456 (country-city-[features]-number)
  country="${BASH_REMATCH[1]}"
  city="${BASH_REMATCH[2]}"
  # BASH_REMATCH[3] is optional features
  number="${BASH_REMATCH[4]}"
elif [[ "$PARSE_NAME" =~ ^([A-Z]{2})#([0-9]+)$ ]]; then
  # Format: SE#130 (country-number)
  country="${BASH_REMATCH[1]}"
  number="${BASH_REMATCH[2]}"
elif [[ "$PARSE_NAME" =~ ^([A-Z]{2})-([0-9]+)$ ]]; then
  # Format: SE-130 (country-number, old style)
  country="${BASH_REMATCH[1]}"
  number="${BASH_REMATCH[2]}"
else
  # Fallback: use the whole filename
  country="Unknown"
  city=""
  number=""
fi

# Determine services (VPN features)
# Check filename and config file for feature indicators
services=""

# Check for P2P support (word boundary matching to avoid false positives)
if [[ "$SERVER_NAME" =~ [Pp]2[Pp] ]] || grep -qiw "p2p" "$CONFIG_FILE" 2>/dev/null; then
  services="${services:+$services,}p2p"
fi

# Check for Tor support (use word boundary to avoid matching "Accelerator", "Monitor", etc.)
if [[ "$SERVER_NAME" =~ -[Tt]or- ]] || [[ "$SERVER_NAME" =~ -[Tt]or$ ]] || [[ "$SERVER_NAME" =~ ^[Tt]or- ]] || grep -qiE '\btor\b' "$CONFIG_FILE" 2>/dev/null; then
  services="${services:+$services,}tor"
fi

# Check for Secure Core (ProtonVPN feature)
if [[ "$SERVER_NAME" =~ [Ss]ecure[_-]?[Cc]ore ]] || grep -qiE 'secure.core|securecore' "$CONFIG_FILE" 2>/dev/null; then
  services="${services:+$services,}securecore"
fi

# Check for Streaming support
if [[ "$SERVER_NAME" =~ [Ss]treaming ]] || grep -qiw "streaming" "$CONFIG_FILE" 2>/dev/null; then
  services="${services:+$services,}streaming"
fi

# Check for Plus/Premium tier servers
if [[ "$SERVER_NAME" =~ [Pp]lus ]] || [[ "$SERVER_NAME" =~ [Pp]remium ]]; then
  services="${services:+$services,}plus"
fi

# Check for Free tier servers
if [[ "$SERVER_NAME" =~ [Ff]ree ]]; then
  services="${services:+$services,}free"
fi

# Default to standard if no special features detected
if [[ -z "$services" ]]; then
  services="standard"
fi

echo "name=$SERVER_NAME"
echo "country=$country"
echo "state=$state"
echo "city=$city"
echo "number=$number"
echo "endpoint=$endpoint"
echo "server_ip=$server_ip"
echo "server_port=$server_port"
echo "dns=$dns"
echo "services=$services"
echo "provider=$provider"
