#!/bin/bash

# Connect to the quickest (lowest latency) server

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lazyvpn-common" || exit 1
# shellcheck source=./lazyvpn-common

CONFIG_DIR="$HOME/.config/lazyvpn"
CONFIG_FILE="$CONFIG_DIR/config"
WG_DIR="$CONFIG_DIR/wireguard"

# Check if killswitch is active and we're disconnected
load_config "$CONFIG_FILE"
if [[ "$KILLSWITCH" == "true" ]] && ! is_connected "${CONNECTION_NAME:-wg0}"; then
  cat << 'EOF'

╔════════════════════════════════════════════════════════════╗
║ Lowest Latency Server Unavailable                          ║
╠════════════════════════════════════════════════════════════╣
║ The lowest latency test requires pinging all servers       ║
║ to measure latency.                                        ║
║                                                            ║
║ The killswitch is currently blocking all internet traffic  ║
║ (you are disconnected from VPN).                           ║
║                                                            ║
║ To use Lowest Latency:                                     ║
║   • Disable the killswitch, or                             ║
║   • Use Random Connect, or                                 ║
║   • Choose a specific server manually                      ║
╚════════════════════════════════════════════════════════════╝

EOF
  read -r -p "Press Enter to continue..."
  exit 0
fi

if [[ ! -d "$WG_DIR" ]] || [[ -z "$(ls -A "$WG_DIR"/*.conf 2>/dev/null)" ]]; then
  notify "No VPN servers found.\nUse '➕ Add New Server' from the menu to import configs."
  echo "Error: No WireGuard configurations found in $WG_DIR"
  exit 1
fi

echo "Testing server latency (parallel)..."
echo ""

RESULTS_DIR=$(mktemp -d)
trap 'rm -rf "$RESULTS_DIR"' EXIT

# Test a single server (runs in background)
test_server() {
  local conf="$1"
  local results_dir="$2"

  local filename
  filename=$(basename "$conf" .conf)
  local result_file="$results_dir/$filename"

  # Extract endpoint IP
  local endpoint
  endpoint=$(grep -m1 "^Endpoint" "$conf" | cut -d= -f2 | tr -d ' ')
  local server_ip
  server_ip=$(echo "$endpoint" | cut -d: -f1)

  # Ping the server (3 packets, 2 second timeout)
  local avg_latency
  avg_latency=$(LC_ALL=C ping -c 3 -W 2 "$server_ip" 2>/dev/null | awk '/^rtt/ {split($4,a,"/"); print int(a[2])}')

  if [[ -n "$avg_latency" ]] && [[ "$avg_latency" =~ ^[0-9]+$ ]]; then
    echo "${avg_latency}" > "$result_file"
    echo "✓ $filename: ${avg_latency}ms"
  else
    echo "✗ $filename: timeout"
  fi
}

# Launch all tests in parallel
for conf in "$WG_DIR"/*.conf; do
  [[ -f "$conf" ]] || continue
  test_server "$conf" "$RESULTS_DIR" &
done

# Wait for all background jobs with timeout
wait

echo ""

# Find the best server from results
BEST_SERVER=""
BEST_LATENCY=99999

for result_file in "$RESULTS_DIR"/*; do
  [[ -f "$result_file" ]] || continue

  filename=$(basename "$result_file")
  latency=$(cat "$result_file")

  if [[ -n "$latency" ]] && [[ "$latency" =~ ^[0-9]+$ ]]; then
    if (( latency < BEST_LATENCY )); then
      BEST_LATENCY=$latency
      BEST_SERVER=$filename
    fi
  fi
done

if [[ -z "$BEST_SERVER" ]]; then
  notify "Could not reach any servers. Check your internet connection."
  echo "Error: Could not find any reachable servers"
  exit 1
fi

# Get pretty server name
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PRETTY_NAME=$(get_pretty_server_name "$BEST_SERVER" "$SCRIPT_DIR")

# Display result
echo "Lowest latency server: $PRETTY_NAME - ${BEST_LATENCY}ms"
echo ""

# Connect to the best server
exec "$SCRIPT_DIR/lazyvpn-connect" "$BEST_SERVER"
