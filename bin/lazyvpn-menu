#!/bin/bash

# LazyVPN Menu - integrated with Omarchy

export PATH="$HOME/.local/share/lazyvpn/bin:$HOME/.local/share/omarchy/bin:$PATH"

# Prevent multiple instances - exit if already running
if pgrep -x "lazyvpn-menu" -u "$USER" | grep -qv "^$$\$"; then
  exit 0
fi

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=./lazyvpn-common
source "$SCRIPT_DIR/lazyvpn-common"

CONFIG_DIR="$HOME/.config/lazyvpn"
CONFIG_FILE="$CONFIG_DIR/config"

# Initialize if needed
if [[ ! -d "$CONFIG_DIR" ]]; then
  "$SCRIPT_DIR/lazyvpn-init" >/dev/null 2>&1
fi

# Set to true when going directly to a submenu
BACK_TO_EXIT=false

back_to() {
  local parent_menu="$1"

  if [[ "$BACK_TO_EXIT" == "true" ]]; then
    exit 0
  elif [[ -n "$parent_menu" ]]; then
    "$parent_menu"
  else
    show_main_menu
  fi
}

menu() {
  local prompt="$1"
  local options="$2"
  local extra="$3"
  local preselect="$4"

  read -r -a args <<<"$extra"

  if [[ -n "$preselect" ]]; then
    local index
    index=$(echo -e "$options" | grep -nxF "$preselect" | cut -d: -f1)
    if [[ -n "$index" ]]; then
      args+=("-c" "$index")
    fi
  fi

  echo -e "$options" | omarchy-launch-walker --dmenu --width 400 --minheight 1 --maxheight 600 -p "$promptâ€¦" "${args[@]}" 2>/dev/null
}

terminal() {
  # Use Omarchy's configured terminal (respects user's terminal preference)
  setsid uwsm-app -- "${TERMINAL:-alacritty}" -e "$@" >/dev/null 2>&1 &
}

country_flag() {
  local code="$1"
  # Convert country code to flag emoji using regional indicator symbols
  # Each letter A-Z maps to Unicode ðŸ‡¦-ðŸ‡¿ (U+1F1E6 to U+1F1FF)
  local flag=""
  for (( i=0; i<${#code}; i++ )); do
    local char="${code:$i:1}"
    # Convert character to uppercase and get its position (A=65 in ASCII)
    local upper
    upper=$(echo "$char" | tr '[:lower:]' '[:upper:]')
    local pos
    pos=$(printf '%d' "'$upper")
    # Regional indicator base is 127462 (0x1F1E6), A starts at 65
    local indicator=$((127462 + pos - 65))
    # Convert to hex and then to emoji
    local hex
    hex=$(printf '%X' "$indicator")
    flag+=$(printf "\\U%s" "$hex")
  done
  echo "$flag"
}

show_main_menu() {
  # Load config to check for last server and settings
  source "$CONFIG_FILE" 2>/dev/null || true

  # Get connection name from config
  local conn_name="${CONNECTION_NAME:-wg0}"

  # Check current status using is_connected from lazyvpn-common
  if is_connected "$conn_name"; then
    # Get server display from last connected
    local server_display=""
    if [[ -n "$LAST_CONNECTED_SERVER" ]]; then
      if [[ "$LAST_CONNECTED_SERVER" =~ ^dynamic:([^:]+):(.+)$ ]]; then
        server_display="${BASH_REMATCH[2]}"
      else
        server_display="$LAST_CONNECTED_SERVER"
      fi
    else
      server_display="$conn_name"
    fi
    prompt="LazyVPN - ðŸŸ¢ $server_display"

    # Connected menu: Disconnect, Dynamic Server List, My Servers, Settings
    local options="ðŸ”Œ  Disconnect\nðŸŒ  Dynamic Server List\nðŸ“  My Servers\nâš™ï¸  Settings"

    case $(menu "$prompt" "$options") in
      *Disconnect*) show_disconnect_confirm ;;
      *Dynamic\ Server\ List*) show_dynamic_server_list ;;
      *My\ Servers*) show_choose_server_menu ;;
      *Settings*) show_settings ;;
    esac
  else
    prompt="LazyVPN - ðŸ”´ Disconnected"

    # Check if there's a last connected server
    local last_server_option=""
    if [[ -n "$LAST_CONNECTED_SERVER" ]]; then
      if [[ "$LAST_CONNECTED_SERVER" =~ ^dynamic:([^:]+):(.+)$ ]]; then
        last_server_display="${BASH_REMATCH[2]}"
      else
        last_server_display="$LAST_CONNECTED_SERVER"
      fi
      last_server_option="ðŸ”„  Reconnect ($last_server_display)\n"
    fi

    # Disconnected menu: Dynamic Server List, My Servers, Reconnect Last Server, Settings
    local options="ðŸŒ  Dynamic Server List\nðŸ“  My Servers\n${last_server_option}âš™ï¸  Settings"

    case $(menu "$prompt" "$options") in
      *Dynamic\ Server\ List*) show_dynamic_server_list ;;
      *My\ Servers*) show_choose_server_menu ;;
      *Reconnect*) show_last_server ;;
      *Settings*) show_settings ;;
    esac
  fi
}

show_settings() {
  # Launch fzf-based settings interface
  omarchy-launch-floating-terminal-with-presentation lazyvpn-settings
  # Return to main menu after settings closes (unless uninstalled)
  [[ -f "$SCRIPT_DIR/lazyvpn-settings" ]] && show_main_menu
}

show_provider_setup() {
  omarchy-launch-floating-terminal-with-presentation lazyvpn-provider-setup
  show_main_menu
}

show_dynamic_server_list() {
  # Check if any providers are configured
  local has_providers=false
  for provider_file in "$CONFIG_DIR/providers"/*.conf; do
    if [[ -f "$provider_file" ]]; then
      has_providers=true
      break
    fi
  done

  if [[ "$has_providers" != "true" ]]; then
    # Show explanation dialog before redirecting to setup
    # After setup, return to main menu so user can access dynamic server list
    case $(menu "No Providers Configured" "ðŸ”‘  Set up a provider now\nâŒ  Cancel") in
      *Set\ up*) show_provider_setup ;;
      *) show_main_menu ;;
    esac
    return
  fi

  # Launch dynamic server browser in floating terminal
  omarchy-launch-floating-terminal-with-presentation lazyvpn-browse-servers
  show_main_menu
}

show_disconnect_confirm() {
  case $(menu "Disconnect" "âœ…  Yes, Disconnect\nâŒ  Cancel") in
    *Yes*)
      omarchy-launch-floating-terminal-with-presentation lazyvpn-disconnect
      show_main_menu
      ;;
    *) show_main_menu ;;
  esac
}

show_last_server() {
  # Load config
  source "$CONFIG_FILE" 2>/dev/null || true

  # Check if there's a last connected server
  if [[ -z "$LAST_CONNECTED_SERVER" ]]; then
    notify "No last server found.\nConnect to a server first."
    back_to show_main_menu
    return
  fi

  # Handle dynamic server format: "dynamic:provider:server_name"
  if [[ "$LAST_CONNECTED_SERVER" =~ ^dynamic:([^:]+):(.+)$ ]]; then
    local provider="${BASH_REMATCH[1]}"
    local server_name="${BASH_REMATCH[2]}"

    # Check if provider is still configured
    if [[ ! -f "$CONFIG_DIR/providers/${provider}.conf" ]]; then
      notify "Provider not configured: $provider\nRun provider setup again."
      back_to show_main_menu
      return
    fi

    # Check if server is in cache
    local cache_file="$CONFIG_DIR/cache/${provider}_servers.json"
    if [[ ! -f "$cache_file" ]]; then
      notify "Server cache not found.\nRefreshing server list..."
      "$SCRIPT_DIR/lazyvpn-fetch-servers" "$provider" >/dev/null 2>&1
    fi

    omarchy-launch-floating-terminal-with-presentation lazyvpn-connect-dynamic "$provider" "$server_name"
    show_main_menu
  else
    # Traditional config file server
    WG_DIR="$CONFIG_DIR/wireguard"

    # Check if the config file still exists
    if [[ ! -f "$WG_DIR/${LAST_CONNECTED_SERVER}.conf" ]]; then
      notify "Last server config not found: ${LAST_CONNECTED_SERVER}\nThe config file may have been deleted."
      back_to show_main_menu
      return
    fi

    omarchy-launch-floating-terminal-with-presentation lazyvpn-connect "$LAST_CONNECTED_SERVER"
    show_main_menu
  fi
}

show_choose_server_menu() {
  # lazyvpn-choose-server handles empty state gracefully
  # (shows favorites + manual configs, or helpful message if empty)
  omarchy-launch-floating-terminal-with-presentation lazyvpn-choose-server
  show_main_menu
}

# Main entry point
if [[ -n "$1" ]]; then
  BACK_TO_EXIT=true
  case "${1,,}" in
    status) show_main_menu ;;
    connect) show_choose_server_menu ;;
    *) show_main_menu ;;
  esac
else
  show_main_menu
fi
