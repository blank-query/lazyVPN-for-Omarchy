#!/bin/bash

# Auto-recover daemon
# Monitors VPN connection and automatically reconnects if it fails

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lazyvpn-common" || exit 1
# shellcheck source=./lazyvpn-common

CONFIG_DIR="$HOME/.config/lazyvpn"
CONFIG_FILE="$CONFIG_DIR/config"
PID_FILE="$CONFIG_DIR/.auto-recover.pid"

# Check if already running
if [[ -f "$PID_FILE" ]]; then
  OLD_PID=$(cat "$PID_FILE")
  if kill -0 "$OLD_PID" 2>/dev/null; then
    echo "Auto-recover daemon already running (PID: $OLD_PID)"
    exit 0
  else
    # Stale PID file
    secure_delete "$PID_FILE"
  fi
fi

# Save PID
echo $$ > "$PID_FILE"

# Cleanup on exit
cleanup() {
  secure_delete "$PID_FILE"
  exit 0
}
trap cleanup EXIT INT TERM

# Load config for debug_log settings
load_config "$CONFIG_FILE"

debug_log autorecover "Auto-recover daemon started (PID: $$)"

# Configuration
CHECK_INTERVAL=5      # seconds between health checks
MAX_HEALTH_FAILURES=3 # health check failures before reconnect attempt
MAX_RETRIES=3         # reconnect attempts before giving up/failover

# State variables
STATE="MONITORING"    # MONITORING, RETRYING, FAILED
HEALTH_FAILURES=0
RETRY_COUNT=0

while true; do
  # Load config each iteration (settings can change)
  load_config "$CONFIG_FILE"

  # Check if auto-recover is still enabled
  if [[ "${AUTO_RECOVER:-false}" != "true" ]]; then
    debug_log autorecover "Auto-recover disabled in config. Stopping."
    exit 0
  fi

  CONN_NAME="${CONNECTION_NAME:-wg0}"
  LAST_SERVER=$(grep "^LAST_CONNECTED_SERVER=" "$CONFIG_FILE" 2>/dev/null | cut -d= -f2)

  # No server configured - nothing to do
  if [[ -z "$LAST_SERVER" ]]; then
    STATE="MONITORING"
    HEALTH_FAILURES=0
    RETRY_COUNT=0
    sleep "$CHECK_INTERVAL"
    continue
  fi

  # Parse server info (needed for reconnect)
  IS_DYNAMIC=false
  PROVIDER=""
  SERVER_NAME=""
  PRETTY_SERVER=""
  ENDPOINT=""

  if [[ "$LAST_SERVER" =~ ^dynamic:([^:]+):(.+)$ ]]; then
    IS_DYNAMIC=true
    PROVIDER="${BASH_REMATCH[1]}"
    SERVER_NAME="${BASH_REMATCH[2]}"
    PRETTY_SERVER="$SERVER_NAME"

    # Look up endpoint from cache
    CACHE_FILE="$CONFIG_DIR/cache/${PROVIDER}_servers.json"
    if [[ -f "$CACHE_FILE" ]] && command -v jq &>/dev/null; then
      SERVER_JSON=$(jq --arg name "$SERVER_NAME" '.[] | select(.server_name == $name)' "$CACHE_FILE" 2>/dev/null)
      if [[ -n "$SERVER_JSON" ]]; then
        ENDPOINT=$(echo "$SERVER_JSON" | jq -r '.ips[0] // empty')
        COUNTRY=$(echo "$SERVER_JSON" | jq -r '.country // ""')
        CITY=$(echo "$SERVER_JSON" | jq -r '.city // ""')
        PRETTY_SERVER="$COUNTRY"
        [[ -n "$CITY" ]] && PRETTY_SERVER+=" - $CITY"
        PRETTY_SERVER+=" ($SERVER_NAME)"
      fi
    fi
  else
    SERVER_NAME="$LAST_SERVER"
    PRETTY_SERVER=$(get_pretty_server_name "$LAST_SERVER" "$SCRIPT_DIR")

    WG_DIR="$CONFIG_DIR/wireguard"
    VPN_CONFIG="$WG_DIR/${LAST_SERVER}.conf"

    if [[ -f "$VPN_CONFIG" ]]; then
      ENDPOINT=$(grep -m1 "^Endpoint" "$VPN_CONFIG" | cut -d= -f2 | tr -d ' ' | cut -d: -f1)
    fi
  fi

  # Can't do anything without endpoint info
  if [[ -z "$ENDPOINT" ]]; then
    debug_log autorecover "Could not determine endpoint for $LAST_SERVER"
    sleep "$CHECK_INTERVAL"
    continue
  fi

  # STATE MACHINE
  case "$STATE" in

    MONITORING)
      if is_connected "$CONN_NAME"; then
        # Connected - do health check
        if ping -c 2 -W 3 -I "$CONN_NAME" "$ENDPOINT" >/dev/null 2>&1; then
          # Healthy
          if [[ $HEALTH_FAILURES -gt 0 ]]; then
            debug_log autorecover "Connection restored to $LAST_SERVER"
            notify "VPN connection restored to $PRETTY_SERVER"
          fi
          HEALTH_FAILURES=0
        else
          # Unhealthy
          ((HEALTH_FAILURES++))
          debug_log autorecover "Health check failed for $LAST_SERVER ($HEALTH_FAILURES/$MAX_HEALTH_FAILURES)"

          if [[ $HEALTH_FAILURES -ge $MAX_HEALTH_FAILURES ]]; then
            debug_log autorecover "Connection to $LAST_SERVER failed. Switching to RETRYING state."
            notify "VPN connection lost!\nAttempting to reconnect..."
            STATE="RETRYING"
            RETRY_COUNT=0
          fi
        fi
      else
        # Not connected but should be - go to retry state
        debug_log autorecover "VPN disconnected unexpectedly. Switching to RETRYING state."
        notify "VPN disconnected!\nAttempting to reconnect..."
        STATE="RETRYING"
        RETRY_COUNT=0
        HEALTH_FAILURES=0
      fi
      ;;

    RETRYING)
      ((RETRY_COUNT++))
      debug_log autorecover "Reconnect attempt $RETRY_COUNT/$MAX_RETRIES to $LAST_SERVER"

      # Attempt reconnect
      RECONNECT_SUCCESS=false
      if [[ "$IS_DYNAMIC" == "true" ]]; then
        if "$SCRIPT_DIR/lazyvpn-connect-dynamic" "$PROVIDER" "$SERVER_NAME" >/dev/null 2>&1; then
          RECONNECT_SUCCESS=true
        fi
      else
        if "$SCRIPT_DIR/lazyvpn-connect" "$LAST_SERVER" >/dev/null 2>&1; then
          RECONNECT_SUCCESS=true
        fi
      fi

      if [[ "$RECONNECT_SUCCESS" == "true" ]]; then
        debug_log autorecover "Successfully reconnected to $LAST_SERVER"
        notify "VPN reconnected to $PRETTY_SERVER"
        STATE="MONITORING"
        HEALTH_FAILURES=0
        RETRY_COUNT=0
      elif [[ $RETRY_COUNT -ge $MAX_RETRIES ]]; then
        # Exhausted retries
        debug_log autorecover "Failed to reconnect after $MAX_RETRIES attempts"

        if [[ "${AUTO_FAILOVER:-false}" == "true" ]]; then
          # Try another server
          debug_log autorecover "Attempting failover to alternate server..."
          notify "Reconnect failed after $MAX_RETRIES attempts\nTrying alternate server..."

          FAILOVER_SUCCESS=false
          if [[ "$KILLSWITCH" == "true" ]] && ! is_connected "$CONN_NAME"; then
            # Use random when killswitch blocks latency test
            debug_log autorecover "Killswitch active - using random server"
            if "$SCRIPT_DIR/lazyvpn-random" >/dev/null 2>&1; then
              FAILOVER_SUCCESS=true
              debug_log autorecover "Failover to random server successful"
              notify "VPN connected to random server"
            fi
          else
            if "$SCRIPT_DIR/lazyvpn-quickest" >/dev/null 2>&1; then
              FAILOVER_SUCCESS=true
              debug_log autorecover "Failover to quickest server successful"
              notify "VPN connected to quickest server"
            fi
          fi

          if [[ "$FAILOVER_SUCCESS" == "true" ]]; then
            STATE="MONITORING"
            HEALTH_FAILURES=0
            RETRY_COUNT=0
          else
            debug_log autorecover "Failover also failed - entering FAILED state"
            notify "VPN failover failed\nManual reconnection required"
            STATE="FAILED"
          fi
        else
          # No failover - give up
          debug_log autorecover "Auto-failover disabled - entering FAILED state"
          notify "VPN reconnect failed\nPlease choose another server"

          # Clear LAST_CONNECTED_SERVER so we don't keep trying
          atomic_config_update "LAST_CONNECTED_SERVER" "" "$CONFIG_FILE"
          STATE="FAILED"
        fi
      else
        # More retries left
        notify "Reconnect attempt $RETRY_COUNT failed\nRetrying..."
      fi
      ;;

    FAILED)
      # Wait for user to manually connect, then resume monitoring
      if is_connected "$CONN_NAME"; then
        debug_log autorecover "User reconnected manually. Resuming monitoring."
        STATE="MONITORING"
        HEALTH_FAILURES=0
        RETRY_COUNT=0
      fi
      ;;

  esac

  sleep "$CHECK_INTERVAL"
done
