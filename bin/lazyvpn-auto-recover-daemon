#!/bin/bash

# Auto-recover daemon
# Monitors VPN connection and automatically reconnects if it fails

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lazyvpn-common" || exit 1
# shellcheck source=./lazyvpn-common

CONFIG_DIR="$HOME/.config/lazyvpn"
CONFIG_FILE="$CONFIG_DIR/config"
PID_FILE="$CONFIG_DIR/.auto-recover.pid"
LOG_FILE="$CONFIG_DIR/auto-recover.log"

# Check if already running
if [[ -f "$PID_FILE" ]]; then
  OLD_PID=$(cat "$PID_FILE")
  if kill -0 "$OLD_PID" 2>/dev/null; then
    echo "Auto-recover daemon already running (PID: $OLD_PID)"
    exit 0
  else
    # Stale PID file
    rm -f "$PID_FILE"
  fi
fi

# Save PID
echo $$ > "$PID_FILE"

# Cleanup on exit
cleanup() {
  rm -f "$PID_FILE"
  exit 0
}
trap cleanup EXIT INT TERM

# Log function
log_message() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >> "$LOG_FILE"
}

log_message "Auto-recover daemon started (PID: $$)"

# Keep log file size reasonable (max 1000 lines)
if [[ -f "$LOG_FILE" ]]; then
  line_count=$(wc -l < "$LOG_FILE")
  if [[ $line_count -gt 1000 ]]; then
    tail -n 500 "$LOG_FILE" > "$LOG_FILE.tmp"
    mv "$LOG_FILE.tmp" "$LOG_FILE"
  fi
fi

# Main monitoring loop
CONSECUTIVE_FAILURES=0
MAX_FAILURES=3
CHECK_INTERVAL=10  # seconds

while true; do
  # Load config
  load_config "$CONFIG_FILE"

  # Check if auto-recover is enabled
  if [[ "${AUTO_RECOVER:-false}" != "true" ]]; then
    log_message "Auto-recover disabled in config. Stopping."
    exit 0
  fi

  CONN_NAME="${CONNECTION_NAME:-wg0}"

  # Check if VPN is supposed to be connected
  if ! is_connected "$CONN_NAME"; then
    # Not connected, reset failure counter
    CONSECUTIVE_FAILURES=0
    sleep "$CHECK_INTERVAL"
    continue
  fi

  # VPN is connected, check health
  LAST_SERVER=$(grep "^LAST_CONNECTED_SERVER=" "$CONFIG_FILE" | cut -d= -f2)

  if [[ -z "$LAST_SERVER" ]]; then
    log_message "No last connected server found"
    sleep "$CHECK_INTERVAL"
    continue
  fi

  # Handle dynamic server format: "dynamic:provider:server_name"
  IS_DYNAMIC=false
  ENDPOINT=""
  PRETTY_SERVER=""

  if [[ "$LAST_SERVER" =~ ^dynamic:([^:]+):(.+)$ ]]; then
    IS_DYNAMIC=true
    PROVIDER="${BASH_REMATCH[1]}"
    SERVER_NAME="${BASH_REMATCH[2]}"
    PRETTY_SERVER="$SERVER_NAME"

    # Look up endpoint from cache
    CACHE_FILE="$CONFIG_DIR/cache/${PROVIDER}_servers.json"
    if [[ -f "$CACHE_FILE" ]] && command -v jq &>/dev/null; then
      SERVER_JSON=$(jq --arg name "$SERVER_NAME" '.[] | select(.server_name == $name)' "$CACHE_FILE" 2>/dev/null)
      if [[ -n "$SERVER_JSON" ]]; then
        ENDPOINT=$(echo "$SERVER_JSON" | jq -r '.ips[0] // empty')
        COUNTRY=$(echo "$SERVER_JSON" | jq -r '.country // ""')
        CITY=$(echo "$SERVER_JSON" | jq -r '.city // ""')
        PRETTY_SERVER="$COUNTRY"
        [[ -n "$CITY" ]] && PRETTY_SERVER+=" - $CITY"
        PRETTY_SERVER+=" ($SERVER_NAME)"
      fi
    fi

    if [[ -z "$ENDPOINT" ]]; then
      log_message "Could not find endpoint for dynamic server $SERVER_NAME"
      sleep "$CHECK_INTERVAL"
      continue
    fi
  else
    # Traditional config file server
    PRETTY_SERVER=$(get_pretty_server_name "$LAST_SERVER" "$SCRIPT_DIR")

    # Get VPN gateway from config
    WG_DIR="$CONFIG_DIR/wireguard"
    VPN_CONFIG="$WG_DIR/${LAST_SERVER}.conf"

    if [[ ! -f "$VPN_CONFIG" ]]; then
      log_message "Config not found for $LAST_SERVER"
      sleep "$CHECK_INTERVAL"
      continue
    fi

    # Get endpoint IP
    ENDPOINT=$(grep -m1 "^Endpoint" "$VPN_CONFIG" | cut -d= -f2 | tr -d ' ' | cut -d: -f1)
  fi

  if [[ -z "$ENDPOINT" ]]; then
    log_message "Could not determine endpoint for $LAST_SERVER"
    sleep "$CHECK_INTERVAL"
    continue
  fi

  # Ping VPN endpoint
  if ping -c 2 -W 3 -I "$CONN_NAME" "$ENDPOINT" >/dev/null 2>&1; then
    # Connection healthy
    if [[ $CONSECUTIVE_FAILURES -gt 0 ]]; then
      log_message "Connection restored to $LAST_SERVER"
      notify "VPN connection restored to $PRETTY_SERVER"
    fi
    CONSECUTIVE_FAILURES=0
  else
    # Connection unhealthy
    ((CONSECUTIVE_FAILURES++))
    log_message "Health check failed for $LAST_SERVER (attempt $CONSECUTIVE_FAILURES/$MAX_FAILURES)"

    if [[ $CONSECUTIVE_FAILURES -ge $MAX_FAILURES ]]; then
      log_message "Connection to $LAST_SERVER failed. Attempting reconnect..."
      notify "VPN connection lost!\nAttempting to reconnect to $PRETTY_SERVER..."

      # Attempt reconnect (handle both dynamic and traditional servers)
      RECONNECT_SUCCESS=false
      if [[ "$IS_DYNAMIC" == "true" ]]; then
        if "$SCRIPT_DIR/lazyvpn-connect-dynamic" "$PROVIDER" "$SERVER_NAME" >> "$LOG_FILE" 2>&1; then
          RECONNECT_SUCCESS=true
        fi
      else
        if "$SCRIPT_DIR/lazyvpn-connect" "$LAST_SERVER" >> "$LOG_FILE" 2>&1; then
          RECONNECT_SUCCESS=true
        fi
      fi

      if [[ "$RECONNECT_SUCCESS" == "true" ]]; then
        log_message "Successfully reconnected to $LAST_SERVER"
        notify "VPN reconnected successfully to $PRETTY_SERVER"
        CONSECUTIVE_FAILURES=0
      else
        log_message "Failed to reconnect to $LAST_SERVER"
        notify "VPN connection failed!\nAttempting to reconnect to $PRETTY_SERVER..."

        # If auto-reconnect fails, check if user wants to try another server
        if [[ "${AUTO_FAILOVER:-false}" == "true" ]]; then
          log_message "Attempting failover to alternate server..."

          # Check if killswitch would block quickest (same logic as autoconnect)
          if [[ "$KILLSWITCH" == "true" ]] && ! is_connected "$CONN_NAME"; then
            # Use random instead of quickest when killswitch blocks
            log_message "Killswitch active - using random server selection"
            if "$SCRIPT_DIR/lazyvpn-random" >> "$LOG_FILE" 2>&1; then
              log_message "Failover successful (used random due to killswitch)"
              notify "VPN failed over to random server"
              CONSECUTIVE_FAILURES=0
            else
              log_message "Failover failed"
            fi
          else
            # Killswitch not blocking, can use quickest
            if "$SCRIPT_DIR/lazyvpn-quickest" >> "$LOG_FILE" 2>&1; then
              log_message "Failover successful"
              notify "VPN failed over to alternate server"
              CONSECUTIVE_FAILURES=0
            else
              log_message "Failover failed"
            fi
          fi
        fi
      fi
    fi
  fi

  sleep "$CHECK_INTERVAL"
done
