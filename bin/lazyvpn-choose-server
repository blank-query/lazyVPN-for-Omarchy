#!/bin/bash

# Choose a VPN server using fzf picker and connect
# Shows favorited dynamic servers and manual configs together

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lazyvpn-common" || exit 1
# shellcheck source=./lazyvpn-common

CONFIG_DIR="$HOME/.config/lazyvpn"
WG_DIR="$CONFIG_DIR/wireguard"
CACHE_DIR="$CONFIG_DIR/cache"
FAVORITES_FILE="$CONFIG_DIR/favorites"

# Build list with pretty names for fzf
TEMP_LIST=$(mktemp)

# Regional indicator symbols for flag emoji
declare -A RI=(
  [A]=$'\U1F1E6' [B]=$'\U1F1E7' [C]=$'\U1F1E8' [D]=$'\U1F1E9' [E]=$'\U1F1EA'
  [F]=$'\U1F1EB' [G]=$'\U1F1EC' [H]=$'\U1F1ED' [I]=$'\U1F1EE' [J]=$'\U1F1EF'
  [K]=$'\U1F1F0' [L]=$'\U1F1F1' [M]=$'\U1F1F2' [N]=$'\U1F1F3' [O]=$'\U1F1F4'
  [P]=$'\U1F1F5' [Q]=$'\U1F1F6' [R]=$'\U1F1F7' [S]=$'\U1F1F8' [T]=$'\U1F1F9'
  [U]=$'\U1F1FA' [V]=$'\U1F1FB' [W]=$'\U1F1FC' [X]=$'\U1F1FD' [Y]=$'\U1F1FE'
  [Z]=$'\U1F1FF'
)

# Add favorited dynamic servers first
if [[ -f "$FAVORITES_FILE" ]]; then
  while IFS=':' read -r provider server_name; do
    [[ -z "$provider" || -z "$server_name" ]] && continue

    cache_file="$CACHE_DIR/${provider}_servers.json"
    [[ ! -f "$cache_file" ]] && continue

    # Get server info from cache
    server_info=$(jaq -r --arg name "$server_name" '
      .[] | select((.server_name // .hostname) == $name) |
      [.country, (.city // ""), (.server_name // .hostname)] | @tsv
    ' "$cache_file" 2>/dev/null)

    [[ -z "$server_info" ]] && continue

    IFS=$'\t' read -r country city name <<< "$server_info"

    # Build display with flag
    cc=""
    if [[ "$name" =~ ^([A-Z]{2})[-#] ]]; then
      cc="${BASH_REMATCH[1]}"
    fi

    display="â­ "
    if [[ ${#cc} -eq 2 ]]; then
      display+="${RI[${cc:0:1}]}${RI[${cc:1:1}]} "
    fi
    display+="$country"
    [[ -n "$city" ]] && display+=" - $city"
    display+=" ($name)"

    # Format: display|type|provider|server_name
    echo "${display}|dynamic|${provider}|${server_name}" >> "$TEMP_LIST"
  done < "$FAVORITES_FILE"
fi

# Add manual configs
if [[ -d "$WG_DIR" ]]; then
  for conf in "$WG_DIR"/*.conf; do
    [[ -f "$conf" ]] || continue

    filename=$(basename "$conf" .conf)
    pretty_name=$(get_pretty_server_name "$filename" "$SCRIPT_DIR")

    # Format: display|type|filename|config_path
    echo "${pretty_name}|manual|${filename}|${conf}" >> "$TEMP_LIST"
  done
fi

# Check if we have anything to show
if [[ ! -s "$TEMP_LIST" ]]; then
  echo "No servers found."
  echo ""
  echo "Add favorites from Dynamic Server List (hotkey 9)"
  echo "or import manual configs from Settings."
  echo ""
  read -r -p "Press Enter to continue..."
  exit 1
fi

# Create preview script as temp file
PREVIEW_SCRIPT=$(mktemp)
trap 'secure_delete "$TEMP_LIST" "$PREVIEW_SCRIPT"' EXIT

cat > "$PREVIEW_SCRIPT" << 'PREVIEW_EOF'
#!/bin/bash
IFS="|" read -r display type arg1 arg2 <<< "$1"
SCRIPT_DIR="$2"
CACHE_DIR="$3"

if [[ "$type" == "dynamic" ]]; then
  provider="$arg1"
  server_name="$arg2"
  cache_file="$CACHE_DIR/${provider}_servers.json"

  # Provider display names
  declare -A PNAMES=(
    [protonvpn]="ProtonVPN"
    [mullvad]="Mullvad"
    [ivpn]="IVPN"
    [pia]="Private Internet Access"
    [nordvpn]="NordVPN"
    [surfshark]="Surfshark"
    [windscribe]="Windscribe"
  )
  provider_display="${PNAMES[$provider]:-$provider}"

  if [[ -f "$cache_file" ]]; then
    echo "Provider: $provider_display"
    jaq -r --arg name "$server_name" '
      .[] | select((.server_name // .hostname) == $name) |
      "Country: \(.country)",
      "City: \(.city // "N/A")",
      "IP: \(.ips[0] // "N/A")",
      "",
      "Features:",
      (if .port_forward then "  ðŸ”„ P2P" else empty end),
      (if .tor then "  ðŸ§… Tor" else empty end),
      (if .secure_core then "  ðŸ”’ Secure Core" else empty end),
      (if .stream then "  ðŸ“º Streaming" else empty end),
      (if .free then "  ðŸ¤¡ Free" else empty end)
    ' "$cache_file" 2>/dev/null
  fi
else
  # Manual config
  server_name="$arg1"
  "$SCRIPT_DIR/lazyvpn-get-server-info" "$server_name" 2>/dev/null
fi
PREVIEW_EOF
chmod +x "$PREVIEW_SCRIPT"

# Use fzf with formatted list and preview
echo ""
echo "Select a server to connect to:"
echo ""

SELECTED=$(cat "$TEMP_LIST" | fzf \
  --prompt="My Servers: " \
  --delimiter='|' \
  --with-nth=1 \
  --no-sort \
  --preview="$PREVIEW_SCRIPT {} '$SCRIPT_DIR' '$CACHE_DIR'" \
  --preview-window=right:40%:wrap \
  --height=80%)

# If no selection (user cancelled)
if [[ -z "$SELECTED" ]]; then
  exit 1
fi

# Parse selection: display|type|arg1|arg2
IFS='|' read -r display type arg1 arg2 <<< "$SELECTED"

echo ""
echo "Connecting to selected server..."
echo ""

if [[ "$type" == "dynamic" ]]; then
  # Dynamic server: arg1=provider, arg2=server_name
  "$SCRIPT_DIR/lazyvpn-connect-dynamic" "$arg1" "$arg2"
else
  # Manual config: arg1=filename
  "$SCRIPT_DIR/lazyvpn-connect" "$arg1"
fi
