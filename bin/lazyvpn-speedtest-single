#!/bin/bash

# Test download speed through a single VPN server

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=./lazyvpn-common
source "$SCRIPT_DIR/lazyvpn-common" || exit 1

SERVER_NAME="$1"

if [[ -z "$SERVER_NAME" ]]; then
  error "Server name required"
  exit 1
fi

CONFIG_DIR="$HOME/.config/lazyvpn"
CONFIG_FILE="$CONFIG_DIR/config"
WG_DIR="$CONFIG_DIR/wireguard"

# Check if killswitch would interfere
load_config "$CONFIG_FILE"
if [[ "$KILLSWITCH" == "true" ]]; then
  # Check if we are currently connected
  if is_connected "${CONNECTION_NAME:-wg0}"; then
    CURRENT_SERVER=$(grep "^LAST_CONNECTED_SERVER=" "$CONFIG_FILE" | cut -d= -f2)
    # If we are trying to test a DIFFERENT server, then the killswitch will block it.
    if [[ "$SERVER_NAME" != "$CURRENT_SERVER" ]]; then
      echo ""
      echo "╔════════════════════════════════════════════════════════════╗"
      echo "║ Speedtest Unavailable for Different Server                 ║"
      echo "╠════════════════════════════════════════════════════════════╣"
      echo "║ The killswitch is active, which prevents connecting to     ║"
      echo "║ any server other than your current one.                    ║"
      echo "║                                                            ║"
      echo "║ To test a different server:                                ║"
      echo "║   • Disable the killswitch first                           ║"
      echo "╚════════════════════════════════════════════════════════════╝"
      echo ""
      exit 0
    fi
  fi
fi

CONF_FILE="$WG_DIR/${SERVER_NAME}.conf"
if [[ ! -f "$CONF_FILE" ]]; then
  error "Server config not found: $CONF_FILE"
  exit 1
fi

# Get pretty server name for display
PRETTY_NAME=$(get_pretty_server_name "$SERVER_NAME" "$SCRIPT_DIR")

# Check if curl is available
if ! command -v curl &> /dev/null; then
  error "Error: curl is required for speed testing"
  exit 1
fi

echo ""
echo "╔════════════════════════════════════════════════════════════╗"
echo "║ VPN Server Speed Test for:                                 ║"
echo "║   $PRETTY_NAME"
echo "╠════════════════════════════════════════════════════════════╣"
echo "║ This will test the download speed through a single server. ║"
echo "║                                                            ║"
echo "║ Process:                                                   ║"
echo "║   • Disconnect if currently connected                      ║"
echo "║   • Connect to the selected server                         ║"
echo "║   • Download a 10MB test file & measure speed              ║"
echo "║   • Disconnect and restore original connection (if any)    ║"
echo "╚════════════════════════════════════════════════════════════╝"
echo ""

read -r -p "Continue with speed test? [y/N] " response
if [[ ! "$response" =~ ^[Yy]$ ]]; then
  echo "Speed test cancelled"
  exit 0
fi

echo ""
echo "Starting speed test for $PRETTY_NAME..."
echo ""

# Test file URL (10MB file from a fast CDN)
TEST_URL="http://speedtest.tele2.net/10MB.zip"

# Store original connection state
ORIGINAL_CONN=""
if is_connected "${CONNECTION_NAME:-wg0}"; then
  ORIGINAL_CONN=$(grep "^LAST_CONNECTED_SERVER=" "$CONFIG_FILE" | cut -d= -f2)
fi

# If user wasn't initially connected, show their public IP before starting
if [[ -z "$ORIGINAL_CONN" ]]; then
  info "Checking current public IP..."
  INITIAL_IP=$(curl -s --connect-timeout 3 --max-time 5 https://api.ipify.org 2>/dev/null)
  if [[ -n "$INITIAL_IP" ]]; then
    info "Current IP: $INITIAL_IP"
  else
    info "Current IP: Unable to retrieve"
  fi
  echo ""
fi

# Only disconnect if we need to switch servers for the test
if [[ -n "$ORIGINAL_CONN" && "$ORIGINAL_CONN" != "$SERVER_NAME" ]]; then
    # Get pretty name for original connection
    ORIGINAL_PRETTY=$(get_pretty_server_name "$ORIGINAL_CONN" "$SCRIPT_DIR")
    info "Temporarily disconnecting from $ORIGINAL_PRETTY to test $PRETTY_NAME..."
    lazyvpn-disconnect >/dev/null 2>&1
fi

# Connect to server (or ensure we are connected if it was already the right one)
if ! lazyvpn-connect "$SERVER_NAME" >/dev/null 2>&1; then
  error "  ✗ Connection to $PRETTY_NAME failed"
  # Attempt to reconnect to original server if we disconnected from it
  if [[ -n "$ORIGINAL_CONN" && "$ORIGINAL_CONN" != "$SERVER_NAME" ]]; then
    lazyvpn-connect "$ORIGINAL_CONN"
  fi
  exit 1
fi

# Wait for connection to stabilize
sleep 2

# If user wasn't initially connected, show public IP via this server
if [[ -z "$ORIGINAL_CONN" ]]; then
  info "Checking public IP through VPN..."
  TEST_IP=$(curl -s --connect-timeout 3 --max-time 5 https://api.ipify.org 2>/dev/null)
  if [[ -n "$TEST_IP" ]]; then
    info "Public IP: $TEST_IP"
  else
    info "Public IP: Unable to retrieve"
  fi
  echo ""
fi

# Download test file and measure speed
speed=$(curl -o /dev/null -s -w '%{speed_download}' --connect-timeout 10 --max-time 30 "$TEST_URL" 2>/dev/null)

# Convert bytes/sec to Mbps
if [[ -n "$speed" ]] && [[ "$speed" != "0.000" ]]; then
  speed_mbps=$(echo "scale=2; $speed * 8 / 1000000" | bc -l 2>/dev/null || echo "0")
  info "✓ Speed for $PRETTY_NAME: ${speed_mbps} Mbps"

  # Record performance data
  record_performance "$SERVER_NAME" "speed" "$speed_mbps" "ok"
else
  error "✗ Speed test failed for $PRETTY_NAME"

  # Record failed performance data
  record_performance "$SERVER_NAME" "speed" "0" "failed"
fi

# If we were originally connected to a different server, disconnect from the test
# server and restore the original connection.
if [[ -n "$ORIGINAL_CONN" && "$ORIGINAL_CONN" != "$SERVER_NAME" ]]; then
  info "Disconnecting from test server..."
  lazyvpn-disconnect >/dev/null 2>&1
  sleep 1
  # Get pretty name for original connection (reuse if already set, otherwise get it)
  if [[ -z "$ORIGINAL_PRETTY" ]]; then
    ORIGINAL_PRETTY=$(get_pretty_server_name "$ORIGINAL_CONN" "$SCRIPT_DIR")
  fi
  info "Restoring original connection to $ORIGINAL_PRETTY..."
  lazyvpn-connect "$ORIGINAL_CONN"
# If we were not connected before, just disconnect from the test server.
elif [[ -z "$ORIGINAL_CONN" ]]; then
  lazyvpn-disconnect >/dev/null 2>&1
  sleep 1

  # Show public IP after disconnecting
  info "Checking public IP after disconnect..."
  FINAL_IP=$(curl -s --connect-timeout 3 --max-time 5 https://api.ipify.org 2>/dev/null)
  if [[ -n "$FINAL_IP" ]]; then
    info "Current IP: $FINAL_IP"
  else
    info "Current IP: Unable to retrieve"
  fi
fi
# If we tested the server we were already on, just leave the connection active.
