#!/bin/bash

# Handle autostart/autoconnect logic

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=./lazyvpn-common
source "$SCRIPT_DIR/lazyvpn-common" || exit 1

CONFIG_FILE="$HOME/.config/lazyvpn/config"

# Wait for network to be ready (with timeout)
info "Waiting for network connectivity..."
NETWORK_READY=false
for i in {1..30}; do
  # Check if we have internet connectivity by pinging a reliable DNS server
  if ping -c 1 -W 2 1.1.1.1 &>/dev/null; then
    info "Network ready after ${i} seconds"
    NETWORK_READY=true
    break
  fi
  sleep 1
done

if [[ "$NETWORK_READY" != "true" ]]; then
  warn "Network not ready after 30 seconds, attempting autoconnect anyway..."
fi

# Double-check systemd-networkd is running
if ! systemctl is-active --quiet systemd-networkd; then
  error "systemd-networkd not running, aborting autoconnect"
fi

# Load config
load_config "$CONFIG_FILE"

# Ensure IPv6 settings are applied if configured (for first boot or migration)
# This handles the case where config says DISABLE_IPV6=true but sysctl/iptables aren't set yet
if [[ "$DISABLE_IPV6" == "true" ]]; then
  # Check if IPv6 is actually disabled at kernel level
  IPV6_STATUS=$(sudo sysctl -n net.ipv6.conf.all.disable_ipv6 2>/dev/null)
  if [[ "$IPV6_STATUS" != "1" ]]; then
    info "IPv6 protection enabled in config but not active - applying now..."

    # Disable IPv6 at kernel level
    sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1 >/dev/null 2>&1
    sudo sysctl -w net.ipv6.conf.default.disable_ipv6=1 >/dev/null 2>&1
    sudo sysctl -w net.ipv6.conf.lo.disable_ipv6=1 >/dev/null 2>&1

    # Create persistent sysctl config if it doesn't exist
    if [[ ! -f /etc/sysctl.d/99-lazyvpn-ipv6.conf ]]; then
      echo "# LazyVPN: Disable IPv6 to prevent leaks" | sudo tee /etc/sysctl.d/99-lazyvpn-ipv6.conf >/dev/null
      echo "net.ipv6.conf.all.disable_ipv6 = 1" | sudo tee -a /etc/sysctl.d/99-lazyvpn-ipv6.conf >/dev/null
      echo "net.ipv6.conf.default.disable_ipv6 = 1" | sudo tee -a /etc/sysctl.d/99-lazyvpn-ipv6.conf >/dev/null
      echo "net.ipv6.conf.lo.disable_ipv6 = 1" | sudo tee -a /etc/sysctl.d/99-lazyvpn-ipv6.conf >/dev/null
    fi

    # Add ip6tables DROP rules as backup
    if ! sudo ip6tables -L LAZYVPN_IPV6_BLOCK -n &>/dev/null; then
      sudo ip6tables -N LAZYVPN_IPV6_BLOCK 2>/dev/null
      sudo ip6tables -F LAZYVPN_IPV6_BLOCK 2>/dev/null
      sudo ip6tables -A LAZYVPN_IPV6_BLOCK -j DROP 2>/dev/null
      sudo ip6tables -I OUTPUT 1 -j LAZYVPN_IPV6_BLOCK 2>/dev/null

      # Save for persistence
      sudo ip6tables-save > /etc/iptables/ip6tables.rules 2>/dev/null
    fi

    info "✓ IPv6 disabled (kernel + firewall)"
  fi
fi

# Start AUTO_RECOVER daemon if enabled
if [[ "$AUTO_RECOVER" == "true" ]]; then
  # Check if daemon is already running
  PID_FILE="$CONFIG_DIR/.auto-recover.pid"
  DAEMON_RUNNING=false

  if [[ -f "$PID_FILE" ]]; then
    OLD_PID=$(cat "$PID_FILE")
    if kill -0 "$OLD_PID" 2>/dev/null; then
      DAEMON_RUNNING=true
    fi
  fi

  if [[ "$DAEMON_RUNNING" != "true" ]]; then
    info "Starting AUTO_RECOVER daemon..."
    nohup "$SCRIPT_DIR/lazyvpn-auto-recover-daemon" >/dev/null 2>&1 &
    info "✓ AUTO_RECOVER daemon started"
  fi
fi

# Only proceed if autoconnect is enabled
if [[ "$AUTOCONNECT" != "true" ]]; then
  exit 0
fi

# Notify user that autoconnect is starting
notify "LazyVPN: Autoconnect starting..."

# Determine which server to connect to
case "$AUTOCONNECT_MODE" in
  quickest)
    # Check if killswitch is blocking (prevents quickest from working)
    if [[ "$KILLSWITCH" == "true" ]] && ! is_connected "${CONNECTION_NAME:-wg0}"; then
      warn "Killswitch is active - cannot test latency to find quickest server"
      warn "Falling back to random server selection"
      notify "LazyVPN: Autoconnecting to random server (killswitch prevents latency test)"
      "$SCRIPT_DIR/lazyvpn-random"
    else
      "$SCRIPT_DIR/lazyvpn-quickest"
    fi
    ;;
  random)
    "$SCRIPT_DIR/lazyvpn-random"
    ;;
  last_used)
    if [[ -n "$LAST_CONNECTED_SERVER" ]]; then
      # Handle dynamic server format: "dynamic:provider:server_name"
      if [[ "$LAST_CONNECTED_SERVER" =~ ^dynamic:([^:]+):(.+)$ ]]; then
        PROVIDER="${BASH_REMATCH[1]}"
        SERVER_NAME="${BASH_REMATCH[2]}"
        "$SCRIPT_DIR/lazyvpn-connect-dynamic" "$PROVIDER" "$SERVER_NAME"
      else
        "$SCRIPT_DIR/lazyvpn-connect" "$LAST_CONNECTED_SERVER"
      fi
    else
      # Fallback to random if no last used server
      warn "No last used server found, connecting to random server"
      "$SCRIPT_DIR/lazyvpn-random"
    fi
    ;;
  specific)
    if [[ -n "$AUTOCONNECT_SERVER" ]]; then
      # Handle dynamic server format: "dynamic:provider:server_name"
      if [[ "$AUTOCONNECT_SERVER" =~ ^dynamic:([^:]+):(.+)$ ]]; then
        PROVIDER="${BASH_REMATCH[1]}"
        SERVER_NAME="${BASH_REMATCH[2]}"
        "$SCRIPT_DIR/lazyvpn-connect-dynamic" "$PROVIDER" "$SERVER_NAME"
      else
        "$SCRIPT_DIR/lazyvpn-connect" "$AUTOCONNECT_SERVER"
      fi
    else
      warn "No specific server configured for autoconnect"
    fi
    ;;
  *)
    warn "Unknown autoconnect mode: $AUTOCONNECT_MODE"
    ;;
esac