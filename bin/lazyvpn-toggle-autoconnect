#!/bin/bash

# Toggle VPN autoconnect (and autostart on boot)

# Source common functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lazyvpn-common" || exit 1
# shellcheck source=./lazyvpn-common

CONFIG_FILE="$HOME/.config/lazyvpn/config"
AUTOSTART_DIR="$HOME/.config/autostart"
DESKTOP_FILE="$AUTOSTART_DIR/lazyvpn.desktop"

# Load current config
load_config "$CONFIG_FILE"

# Toggle autoconnect
if [[ "$AUTOCONNECT" == "true" ]]; then
  NEW_VALUE="false"
  info "Disabling autoconnect..."

  # Remove autostart desktop file
  secure_delete "$DESKTOP_FILE"
else
  NEW_VALUE="true"
  info "Enabling autoconnect..."

  # Create autostart directory
  if ! mkdir -p "$AUTOSTART_DIR"; then
    error "Failed to create autostart directory: $AUTOSTART_DIR"
  fi

  # Create desktop file for autostart on boot
  # Note: We need to use absolute path since desktop files don't inherit PATH
  cat > "$DESKTOP_FILE" << EOF
[Desktop Entry]
Type=Application
Name=LazyVPN Autostart
Exec=$SCRIPT_DIR/lazyvpn-autostart-handler
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
EOF

  if [[ ! -f "$DESKTOP_FILE" ]]; then
    error "Failed to create autostart desktop file"
  fi
fi

# Update config file atomically (both AUTOCONNECT and AUTOSTART for compatibility)
if ! atomic_config_update "AUTOCONNECT" "$NEW_VALUE" "$CONFIG_FILE"; then
  error "Failed to update autoconnect setting in config"
fi

if ! atomic_config_update "AUTOSTART" "$NEW_VALUE" "$CONFIG_FILE"; then
  warn "Failed to update autostart setting in config"
fi

info "Autoconnect: $NEW_VALUE"

if [[ "$NEW_VALUE" == "true" ]]; then
  info "Autoconnect mode: $AUTOCONNECT_MODE"
  if [[ "$AUTOCONNECT_MODE" == "specific" && -n "$AUTOCONNECT_SERVER" ]]; then
    info "Will connect to: $AUTOCONNECT_SERVER"
  fi
  info "LazyVPN will start automatically on boot"
fi
